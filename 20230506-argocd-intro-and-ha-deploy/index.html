

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="Argo CD是一个开源的GitOps工具，用于自动化部署、操作和观察基于Kubernetes的应用程序和配置，提供声明式应用程序定义、多环境支持、应用程序状态监控、RBAC和安全性、插件和扩展性等功能。通过与Git集成，它实现了将应用程序和配置定义存储在Git存储库中，并将其自动同步到Kubernetes环境，实现应用程序的自动化部署和更新。 本文主要介绍argocd的基础架构和核心概念，同时会">
<meta property="og:type" content="article">
<meta property="og:title" content="Argocd核心概念及高可用部署">
<meta property="og:url" content="https://tinychen.com/20230506-argocd-intro-and-ha-deploy/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio - 互联网技术学习工作经验分享">
<meta property="og:description" content="Argo CD是一个开源的GitOps工具，用于自动化部署、操作和观察基于Kubernetes的应用程序和配置，提供声明式应用程序定义、多环境支持、应用程序状态监控、RBAC和安全性、插件和扩展性等功能。通过与Git集成，它实现了将应用程序和配置定义存储在Git存储库中，并将其自动同步到Kubernetes环境，实现应用程序的自动化部署和更新。 本文主要介绍argocd的基础架构和核心概念，同时会">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/202307131730364.jpg">
<meta property="article:published_time" content="2023-05-06T07:00:00.000Z">
<meta property="article:modified_time" content="2023-07-13T07:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="argocd">
<meta property="article:tag" content="git">
<meta property="article:tag" content="gitops">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/202307131730364.jpg">
  
  
  <title>Argocd核心概念及高可用部署 - TinyChen&#39;s Studio - 互联网技术学习工作经验分享</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/dracula.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/fluid-extention.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio - 互联网技术学习工作经验分享" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://resource.tinychen.com/202307131730221.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Argocd核心概念及高可用部署">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2023-05-06 15:00" pubdate>
        May 6, 2023 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      21k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Argocd核心概念及高可用部署</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：July 13, 2023 pm
                
              </p>
            
            <div class="markdown-body">
              <p>Argo CD是一个开源的GitOps工具，用于自动化部署、操作和观察基于Kubernetes的应用程序和配置，提供声明式应用程序定义、多环境支持、应用程序状态监控、RBAC和安全性、插件和扩展性等功能。通过与Git集成，它实现了将应用程序和配置定义存储在Git存储库中，并将其自动同步到Kubernetes环境，实现应用程序的自动化部署和更新。</p>
<p>本文主要介绍argocd的基础架构和核心概念，同时会手把手进行高可用部署并进行初始化配置和应用部署，文章较长，有兴趣的同学可以根据目录进行跳转阅读。</p>
<span id="more"></span>


<h1 id="1、部署argocd"><a href="#1、部署argocd" class="headerlink" title="1、部署argocd"></a>1、部署argocd</h1><p>我们可以参考argocd官网的<a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/getting_started/">快速开始指南</a>，在开始之前我们需要先准备一个能够正常使用的K8S集群，我们这里使用的是1.27.0版本的社区原生K8S进行部署。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get nodes -o wide<br>NAME                         STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE                KERNEL-VERSION              CONTAINER-RUNTIME<br>k8s-10-31-90-1.tinychen.io   Ready    control-plane   96d   v1.27.0   10.31.90.1    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br>k8s-10-31-90-2.tinychen.io   Ready    control-plane   96d   v1.27.0   10.31.90.2    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br>k8s-10-31-90-3.tinychen.io   Ready    control-plane   96d   v1.27.0   10.31.90.3    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br>k8s-10-31-90-4.tinychen.io   Ready    &lt;none&gt;          96d   v1.27.0   10.31.90.4    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br>k8s-10-31-90-5.tinychen.io   Ready    &lt;none&gt;          96d   v1.27.0   10.31.90.5    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br>k8s-10-31-90-6.tinychen.io   Ready    &lt;none&gt;          96d   v1.27.0   10.31.90.6    &lt;none&gt;        CentOS Linux 7 (Core)   6.1.4-1.el7.elrepo.x86_64   containerd://1.6.14<br></code></pre></div></td></tr></table></figure>

<p>该集群使用cilium作为CNI，containerd作为CRI，注意部署argocd并不需要用到持久化存储，但是最好能有一种手段用来暴露argocd的api接口（如四层的loadbalance或者七层的ingress/apigateway等）。</p>
<h1 id="2、架构组件"><a href="#2、架构组件" class="headerlink" title="2、架构组件"></a>2、架构组件</h1><p>先来看一下官方提供的这个<a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/developer-guide/architecture/components/">架构图</a>，注意默认情况下Argo CD部署时会配置多种组件和Kubernetes controllers。这些Kubernetes controllers更倾向于CRD而不是模块化的组件，因此在架构图中并没有将其表现出来，与此相似的还有一些如configmap、service、secret的配置。</p>
<p><img src="https://resource.tinychen.com/202305221547394.png" srcset="/img/loading.gif" lazyload></p>
<p>官方的架构图中将整个Argo CD系统分为四个逻辑层级：<strong>UI、Application、Core和Infra</strong>。逻辑层还有助于使图表更易于理解，因为依赖关系以自上而下的关系表示。这意味着来自顶层的组件将被允许依赖于来自任何底层的任何组件。然而，来自底层的组件永远不会依赖于来自上层的任何组件。</p>
<ul>
<li><strong>UI</strong>：这是表示层。用户主要通过这一层的组件与 Argo CD 进行交互（包括WebUI和CLI）。</li>
<li><strong>Application</strong>：支持来自 UI 层的组件所需的功能。</li>
<li><strong>Core</strong>：主要的 Argo CD gitops 功能由核心层的组件和 Kubernetes 控制器实现。</li>
<li><strong>Infra</strong>：表示 Argo CD 作为其基础设施的一部分所依赖的工具。</li>
</ul>
<p>以下是各个组件的主要职责，我们在平时维护的时候可以根据这些信息来快速定位故障：</p>
<ul>
<li><strong>Webapp</strong>：Argo CD 附带一个强大的 Web 界面，允许管理部署在给定 Kubernetes 集群中的应用程序；</li>
<li><strong>CLI</strong>：Argo CD 提供了一个 CLI，用户可以使用它与 Argo CD API 进行交互。 CLI 还可用于自动化和脚本编写；</li>
<li><strong>API Server</strong>：定义由 Argo CD 公开的专有 API，该 API 为 Web 应用程序和 CLI 功能提供支持；</li>
<li><strong>Application Controller</strong>：应用程序控制器负责协调 Kubernetes 中的应用程序资源和项目资源，并将所需的应用程序状态（在 Git 中提供）与实时状态（在 Kubernetes 中）同步；</li>
<li><strong>ApplicationSet Controller</strong>：ApplicationSet Controller 负责协调 ApplicationSet 资源，<code>applicationset</code>是argo创建的一个CRD；</li>
<li><strong>Repo Server</strong>：Repo Server 在 Argo CD 架构中起着重要作用，因为它负责与 Git 存储库交互，为属于给定 application 的所有 Kubernetes 资源生成所需的状态；</li>
<li><strong>Redis</strong>：Argo CD 使用 Redis 来提供缓存层，减少发送到K8S的API Server和Git服务器的请求。它还支持一些 UI 操作；</li>
<li><strong>Kube API</strong>：Argo CD 控制器将连接到K8S的API Server以执行操作。因此如果需要管理多个集群时，在部署了argocd之外的集群是不需要部署任何argocd的客户端程序的，只需要创建一个<code>ServiceAccount</code>用于管理权限；</li>
<li><strong>Git</strong>：作为 gitops 工具，Argo CD 要求在 Git 存储库中提供所需的 Kubernetes 资源状态。 我们在这里使用<code>git</code>来代表实际的 git 存储库、Helm 存储库或 OCI 工件存储库。 Argo CD 支持所有这些选项；</li>
<li><strong>Dex</strong>：Argo CD 依赖于 Dex 来提供与外部 OIDC 提供商的身份验证。当然，可以使用其他工具代替 Dex；</li>
</ul>
<h1 id="3、核心概念"><a href="#3、核心概念" class="headerlink" title="3、核心概念"></a>3、核心概念</h1><p><a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/core_concepts/">官方文档</a>假定我们熟悉核心 Git、Docker、Kubernetes、持续交付（Continuous Delivery）和 GitOps 概念，对一些特定于 Argo CD 的概念进行了介绍，这里摘取了一些个人认为比较重要且基础的概念进行二次阐述。</p>
<ul>
<li><p><strong>Application</strong>：Argocd中的核心概念之一，在K8S中以CRD的形式存在，用来表示一组由manifest定义的K8S资源集合。例如我们需要部署一个服务，该服务涉及的K8S资源可能包括若干个deployment、svc以及configmap等多种类型，在argocd中将其统一按照Application的概念进行划分，这些资源都归属于同一个Application下进行配置。</p>
</li>
<li><p><strong>Target state</strong>：期望该Application下的各种资源类型的运行状态，由对应Git仓库中的文件进行定义。</p>
</li>
<li><p><strong>Live state</strong>：目前该Application下的各种资源类型的运行状态。</p>
</li>
<li><p><strong>Sync status</strong>：实时状态是否与目标状态匹配，部署的应用程序是否与Git仓库中定义的状态一致。正常情况下应是Synced并且指向该Git的最新版本分支。</p>
</li>
<li><p><strong>Sync</strong>：将 Git 中的最新代码与实时状态进行对比并将变更同步到K8S集群中，将其可以视为主动触发同步git状态的操作。</p>
</li>
<li><p><strong>Sync operation status</strong>：同步是否成功。</p>
</li>
<li><p><strong>Refresh</strong>：将Git中的最新代码与实时状态进行对比。</p>
</li>
<li><p><strong>Health</strong>：应用程序的健康状况，如是否正常运行，能否接收并处理外部请求等。</p>
</li>
</ul>
<h1 id="4、高可用部署argocd"><a href="#4、高可用部署argocd" class="headerlink" title="4、高可用部署argocd"></a>4、高可用部署argocd</h1><p>高可用部署的yaml文件可以在github上面获取</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/argoproj/</span>argo-cd<span class="hljs-regexp">/blob/m</span>aster<span class="hljs-regexp">/manifests/</span>ha/namespace-install.yaml<br></code></pre></div></td></tr></table></figure>

<p>同时需要注意对应的CRD资源需要单独部署</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">https:<span class="hljs-regexp">//gi</span>thub.com<span class="hljs-regexp">/argoproj/</span>argo-cd<span class="hljs-regexp">/tree/m</span>aster<span class="hljs-regexp">/manifests/</span>crds<br></code></pre></div></td></tr></table></figure>

<p>部署的文档可以参考官方的latest版本</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>argo-cd.readthedocs.io<span class="hljs-regexp">/en/</span>latest<span class="hljs-regexp">/operator-manual/i</span>nstallation/<br></code></pre></div></td></tr></table></figure>

<p>我们来看一下部署文件的结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ tree argocd/<br>argocd/<br>|-- crds<br>|   |-- application-crd.yaml<br>|   |-- applicationset-crd.yaml<br>|   |-- appproject-crd.yaml<br>|   `-- kustomization.yaml<br>`-- ha<br>    `-- namespace-install.yaml<br><br>2 directories, 5 files<br></code></pre></div></td></tr></table></figure>

<p>部署环节我们可以分为三步，部署CRD资源、创建namespace、部署workload及相关配置。</p>
<p>首先我们定位到<code>crds</code>目录下面，直接部署对应的三个crd文件用于创建对应的crd资源。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f application-crd.yaml -f applicationset-crd.yaml -f appproject-crd.yaml<br>customresourcedefinition.apiextensions.k8s.io/applications.argoproj.io created<br>customresourcedefinition.apiextensions.k8s.io/applicationsets.argoproj.io created<br>customresourcedefinition.apiextensions.k8s.io/appprojects.argoproj.io created<br></code></pre></div></td></tr></table></figure>

<p>接着手动创建一个namespace，名字不一定为argocd，可以是你喜欢的任意值，但是注意后面指定的namespace要和这里相同。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl create ns argocd<br>namespace/argocd created<br></code></pre></div></td></tr></table></figure>

<p>最后定位到<code>ha</code>目录下，直接部署argocd对应的全部工作负载，注意部署的时候指定namespace，否则会部署到默认的default namespace下。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f namespace-install.yaml -n argocd<br>serviceaccount/argocd-application-controller created<br>serviceaccount/argocd-applicationset-controller created<br>serviceaccount/argocd-dex-server created<br>serviceaccount/argocd-notifications-controller created<br>serviceaccount/argocd-redis-ha created<br>serviceaccount/argocd-redis-ha-haproxy created<br>serviceaccount/argocd-repo-server created<br>serviceaccount/argocd-server created<br>role.rbac.authorization.k8s.io/argocd-application-controller created<br>role.rbac.authorization.k8s.io/argocd-applicationset-controller created<br>role.rbac.authorization.k8s.io/argocd-dex-server created<br>role.rbac.authorization.k8s.io/argocd-notifications-controller created<br>role.rbac.authorization.k8s.io/argocd-redis-ha created<br>role.rbac.authorization.k8s.io/argocd-redis-ha-haproxy created<br>role.rbac.authorization.k8s.io/argocd-server created<br>rolebinding.rbac.authorization.k8s.io/argocd-application-controller created<br>rolebinding.rbac.authorization.k8s.io/argocd-applicationset-controller created<br>rolebinding.rbac.authorization.k8s.io/argocd-dex-server created<br>rolebinding.rbac.authorization.k8s.io/argocd-notifications-controller created<br>rolebinding.rbac.authorization.k8s.io/argocd-redis-ha created<br>rolebinding.rbac.authorization.k8s.io/argocd-redis-ha-haproxy created<br>rolebinding.rbac.authorization.k8s.io/argocd-server created<br>configmap/argocd-cm created<br>configmap/argocd-cmd-params-cm created<br>configmap/argocd-gpg-keys-cm created<br>configmap/argocd-notifications-cm created<br>configmap/argocd-rbac-cm created<br>configmap/argocd-redis-ha-configmap created<br>configmap/argocd-redis-ha-health-configmap created<br>configmap/argocd-ssh-known-hosts-cm created<br>configmap/argocd-tls-certs-cm created<br>secret/argocd-notifications-secret created<br>secret/argocd-secret created<br>service/argocd-applicationset-controller created<br>service/argocd-dex-server created<br>service/argocd-metrics created<br>service/argocd-notifications-controller-metrics created<br>service/argocd-redis-ha created<br>service/argocd-redis-ha-announce-0 created<br>service/argocd-redis-ha-announce-1 created<br>service/argocd-redis-ha-announce-2 created<br>service/argocd-redis-ha-haproxy created<br>service/argocd-repo-server created<br>service/argocd-server created<br>service/argocd-server-metrics created<br>deployment.apps/argocd-applicationset-controller created<br>deployment.apps/argocd-dex-server created<br>deployment.apps/argocd-notifications-controller created<br>deployment.apps/argocd-redis-ha-haproxy created<br>deployment.apps/argocd-repo-server created<br>deployment.apps/argocd-server created<br>statefulset.apps/argocd-application-controller created<br>statefulset.apps/argocd-redis-ha-server created<br>networkpolicy.networking.k8s.io/argocd-application-controller-network-policy created<br>networkpolicy.networking.k8s.io/argocd-applicationset-controller-network-policy created<br>networkpolicy.networking.k8s.io/argocd-dex-server-network-policy created<br>networkpolicy.networking.k8s.io/argocd-notifications-controller-network-policy created<br>networkpolicy.networking.k8s.io/argocd-redis-ha-proxy-network-policy created<br>networkpolicy.networking.k8s.io/argocd-redis-ha-server-network-policy created<br>networkpolicy.networking.k8s.io/argocd-repo-server-network-policy created<br>networkpolicy.networking.k8s.io/argocd-server-network-policy created<br></code></pre></div></td></tr></table></figure>

<p>部署完成后检查部署的pod是否正常运行，此时所有的pod应该都在argocd这个namespace下。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get pods -n argocd -o wide<br>NAME                                                READY   STATUS    RESTARTS   AGE     IP            NODE                         NOMINATED NODE   READINESS GATES<br>argocd-application-controller-0                     1/1     Running   0          5m42s   10.33.4.166   k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-applicationset-controller-559cc454d9-wx5vf   1/1     Running   0          5m43s   10.33.4.217   k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-dex-server-76487b6695-vvkwr                  1/1     Running   0          5m43s   10.33.4.133   k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-notifications-controller-65b795c756-mtxb5    1/1     Running   0          5m43s   10.33.3.18    k8s-10-31-90-4.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-haproxy-6745ff898d-6rb2n            1/1     Running   0          5m43s   10.33.4.85    k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-haproxy-6745ff898d-dbn58            1/1     Running   0          5m43s   10.33.3.212   k8s-10-31-90-4.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-haproxy-6745ff898d-w2hlh            1/1     Running   0          5m43s   10.33.5.211   k8s-10-31-90-6.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-server-0                            3/3     Running   0          5m42s   10.33.5.163   k8s-10-31-90-6.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-server-1                            3/3     Running   0          2m41s   10.33.4.188   k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-redis-ha-server-2                            3/3     Running   0          86s     10.33.3.113   k8s-10-31-90-4.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-repo-server-5c8f8d4fbd-fp9jt                 1/1     Running   0          5m42s   10.33.4.230   k8s-10-31-90-5.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-repo-server-5c8f8d4fbd-gchwd                 1/1     Running   0          5m42s   10.33.3.213   k8s-10-31-90-4.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-server-5684688df7-7grxl                      1/1     Running   0          5m42s   10.33.5.55    k8s-10-31-90-6.tinychen.io   &lt;none&gt;           &lt;none&gt;<br>argocd-server-5684688df7-gxbsf                      1/1     Running   0          5m42s   10.33.3.226   k8s-10-31-90-4.tinychen.io   &lt;none&gt;           &lt;none&gt;<br></code></pre></div></td></tr></table></figure>

<p>最后检查对应的svc是否存在，同理此时所有的svc应该也都在argocd这个namespace下。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n argocd<br>NAME                                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE<br>argocd-applicationset-controller          ClusterIP   10.33.182.73    &lt;none&gt;        7000/TCP,8080/TCP            12m<br>argocd-dex-server                         ClusterIP   10.33.130.105   &lt;none&gt;        5556/TCP,5557/TCP,5558/TCP   12m<br>argocd-metrics                            ClusterIP   10.33.167.226   &lt;none&gt;        8082/TCP                     12m<br>argocd-notifications-controller-metrics   ClusterIP   10.33.191.67    &lt;none&gt;        9001/TCP                     12m<br>argocd-redis-ha                           ClusterIP   None            &lt;none&gt;        6379/TCP,26379/TCP           12m<br>argocd-redis-ha-announce-0                ClusterIP   10.33.182.204   &lt;none&gt;        6379/TCP,26379/TCP           12m<br>argocd-redis-ha-announce-1                ClusterIP   10.33.158.122   &lt;none&gt;        6379/TCP,26379/TCP           12m<br>argocd-redis-ha-announce-2                ClusterIP   10.33.147.25    &lt;none&gt;        6379/TCP,26379/TCP           12m<br>argocd-redis-ha-haproxy                   ClusterIP   10.33.190.134   &lt;none&gt;        6379/TCP                     12m<br>argocd-repo-server                        ClusterIP   10.33.187.87    &lt;none&gt;        8081/TCP,8084/TCP            12m<br>argocd-server                             ClusterIP   10.33.160.176   &lt;none&gt;        80/TCP,443/TCP               12m<br>argocd-server-metrics                     ClusterIP   10.33.177.208   &lt;none&gt;        8083/TCP                     12m<br></code></pre></div></td></tr></table></figure>

<h1 id="5、部署CLI"><a href="#5、部署CLI" class="headerlink" title="5、部署CLI"></a>5、部署CLI</h1><p>CLI的部署可以参考文档</p>
<figure class="highlight awk"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs awk">https:<span class="hljs-regexp">//</span>argo-cd.readthedocs.io<span class="hljs-regexp">/en/</span>latest<span class="hljs-regexp">/cli_installation/</span><br></code></pre></div></td></tr></table></figure>

<p>我们直接下载对应系统版本的二进制文件即可。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64<br>$ sudo install -m 555 argocd-linux-amd64 /usr/<span class="hljs-built_in">local</span>/bin/argocd<br>$ rm argocd-linux-amd64<br></code></pre></div></td></tr></table></figure>

<p>安装完成之后输入<code>argocd --help</code>查看CLI是否能够正常运行</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd --<span class="hljs-built_in">help</span><br>argocd controls a Argo CD server<br><br>Usage:<br>  argocd [flags]<br>  argocd [<span class="hljs-built_in">command</span>]<br><br>Available Commands:<br>  account     Manage account settings<br>  admin       Contains a <span class="hljs-built_in">set</span> of commands useful <span class="hljs-keyword">for</span> Argo CD administrators and requires direct Kubernetes access<br>  app         Manage applications<br>  appset      Manage ApplicationSets<br>  cert        Manage repository certificates and SSH known hosts entries<br>  cluster     Manage cluster credentials<br>  completion  output shell completion code <span class="hljs-keyword">for</span> the specified shell (bash or zsh)<br>  context     Switch between contexts<br>  gpg         Manage GPG keys used <span class="hljs-keyword">for</span> signature verification<br>  <span class="hljs-built_in">help</span>        Help about any <span class="hljs-built_in">command</span><br>  login       Log <span class="hljs-keyword">in</span> to Argo CD<br>  <span class="hljs-built_in">logout</span>      Log out from Argo CD<br>  proj        Manage projects<br>  relogin     Refresh an expired authenticate token<br>  repo        Manage repository connection parameters<br>  repocreds   Manage repository connection parameters<br>  version     Print version information<br><br>Flags:<br>      --auth-token string               Authentication token<br>      --client-crt string               Client certificate file<br>      --client-crt-key string           Client certificate key file<br>      --config string                   Path to Argo CD config (default <span class="hljs-string">&quot;/root/.config/argocd/config&quot;</span>)<br>      --core                            If <span class="hljs-built_in">set</span> to <span class="hljs-literal">true</span> <span class="hljs-keyword">then</span> CLI talks directly to Kubernetes instead of talking to Argo CD API server<br>      --grpc-web                        Enables gRPC-web protocol. Useful <span class="hljs-keyword">if</span> Argo CD server is behind proxy <span class="hljs-built_in">which</span> does not support HTTP2.<br>      --grpc-web-root-path string       Enables gRPC-web protocol. Useful <span class="hljs-keyword">if</span> Argo CD server is behind proxy <span class="hljs-built_in">which</span> does not support HTTP2. Set web root.<br>  -H, --header strings                  Sets additional header to all requests made by Argo CD CLI. (Can be repeated multiple <span class="hljs-built_in">times</span> to add multiple headers, also supports comma separated headers)<br>  -h, --<span class="hljs-built_in">help</span>                            <span class="hljs-built_in">help</span> <span class="hljs-keyword">for</span> argocd<br>      --http-retry-max int              Maximum number of retries to establish http connection to Argo CD server<br>      --insecure                        Skip server certificate and domain verification<br>      --kube-context string             Directs the <span class="hljs-built_in">command</span> to the given kube-context<br>      --logformat string                Set the logging format. One of: text|json (default <span class="hljs-string">&quot;text&quot;</span>)<br>      --loglevel string                 Set the logging level. One of: debug|info|warn|error (default <span class="hljs-string">&quot;info&quot;</span>)<br>      --plaintext                       Disable TLS<br>      --port-forward                    Connect to a random argocd-server port using port forwarding<br>      --port-forward-namespace string   Namespace name <span class="hljs-built_in">which</span> should be used <span class="hljs-keyword">for</span> port forwarding<br>      --server string                   Argo CD server address<br>      --server-crt string               Server certificate file<br><br>Use <span class="hljs-string">&quot;argocd [command] --help&quot;</span> <span class="hljs-keyword">for</span> more information about a <span class="hljs-built_in">command</span>.<br></code></pre></div></td></tr></table></figure>

<p>argocd CLI的默认配置文件会放置在<code>~/.config/argocd/config</code>目录下，当然也可以像kubectl一样使用<code>--config</code>手动指定。</p>
<h1 id="6、暴露argocd"><a href="#6、暴露argocd" class="headerlink" title="6、暴露argocd"></a>6、暴露argocd</h1><h2 id="6-1-配置argocd-server"><a href="#6-1-配置argocd-server" class="headerlink" title="6.1 配置argocd-server"></a>6.1 配置argocd-server</h2><p>想要使用集群外的argocd cli来操控集群内的argocd，比较优雅的方式是通过LoadBalancer暴露一个EXTERNAL-IP给集群外的服务访问</p>
<p>如果你的集群支持LoadBalancer类型的服务，可以参考下面的配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl patch svc argocd-server -n argocd -p <span class="hljs-string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;&#125;&#125;&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>这里使用的测试集群部署了purelb，因此还可以精细化操作一下，指定特定的VIP方便我们后续配置</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 我们直接一步到位，直接添加注解、设置svc的类型为LoadBalancer并手动指定loadBalancerIP</span><br>$ kubectl patch svc argocd-server -n argocd -p <span class="hljs-string">&#x27;&#123;&quot;metadata&quot;:&#123;&quot;annotations&quot;:&#123;&quot;purelb.io/service-group&quot;:&quot;bgp-ippool&quot;&#125;&#125;,&quot;spec&quot;: &#123;&quot;type&quot;: &quot;LoadBalancer&quot;,&quot;loadBalancerIP&quot;:&quot;10.33.192.2&quot;&#125;&#125;&#x27;</span><br></code></pre></div></td></tr></table></figure>

<p>随后我们检查一下服务是否暴露成功</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n argocd argocd-server<br>NAME            TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE<br>argocd-server   LoadBalancer   10.33.160.176   10.33.192.2   80:30149/TCP,443:31991/TCP   88m<br></code></pre></div></td></tr></table></figure>

<p>正常情况下我们通过这里暴露出来的VIP <code>10.33.192.2</code>可以访问对应的web界面，同时CLI工具也可以直接连接<code>10.33.192.2</code>进行操作。</p>
<blockquote>
<p>当然我们也可以通过ingress来进行配置，具体可以参考<a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/operator-manual/ingress/">官方的文档</a>，上面提供了多种ingress的配置案例。</p>
</blockquote>
<p>我们这里为了方便用户访问webUI，使用NGX做一层反向代理，配置域名为<code>argocd.tinychen.com</code>，转发到<code>10.33.192.2</code>的<code>443</code>端口。</p>
<blockquote>
<p>默认情况下argocd会暴露两个端口，其中80端口会自动重定向到443端口，因为我们配置反向代理的需要需要额外注意。</p>
<ul>
<li>443 - gRPC/HTTPS</li>
<li>80 - HTTP (redirects to HTTPS)</li>
</ul>
<p>如果配置的反向代理服务器不支持HTTP2可以考虑使用–grpc-web参数</p>
<p>–grpc-web                        Enables gRPC-web protocol. Useful if Argo CD server is behind proxy which does not support HTTP2.</p>
</blockquote>
<h2 id="6-2-修改初始账号密码"><a href="#6-2-修改初始账号密码" class="headerlink" title="6.2 修改初始账号密码"></a>6.2 修改初始账号密码</h2><p>argocd的初始密码是使用<code>secrets</code>明文存储在k8s的<code>argocd-initial-admin-secret</code>中，我们可以直接获取并进行base64解码</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get secrets -n argocd argocd-initial-admin-secret -o yaml<br>apiVersion: v1<br>data:<br>  password: UUFkdDFNRGZsaXFhZjVtUQ==<br>kind: Secret<br>metadata:<br>  creationTimestamp: <span class="hljs-string">&quot;2023-05-04T07:50:34Z&quot;</span><br>  name: argocd-initial-admin-secret<br>  namespace: argocd<br>  resourceVersion: <span class="hljs-string">&quot;23555422&quot;</span><br>  uid: 9c0db11e-7db0-4432-9bf4-da7c5668b4e5<br><span class="hljs-built_in">type</span>: Opaque<br><br>$ <span class="hljs-built_in">echo</span> UUFkdDFNRGZsaXFhZjVtUQ== | base64 -d<br>QAdt1MDfliqaf5mQ<br></code></pre></div></td></tr></table></figure>

<p>当然也可以通过CLI工具来快速获取初始密码</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd admin initial-password -n argocd<br>QAdt1MDfliqaf5mQ<br><br> This password must be only used <span class="hljs-keyword">for</span> first time login. We strongly recommend you update the password using `argocd account update-password`.<br></code></pre></div></td></tr></table></figure>

<p>获取初始密码之后，我们可以使用初始账号<code>admin</code>和初始密码进行登录，然后进行密码的修改。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 先使用初始密码登录</span><br>$ argocd login argocd.tinychen.com<br>Username: admin<br>Password:<br><span class="hljs-string">&#x27;admin:login&#x27;</span> logged <span class="hljs-keyword">in</span> successfully<br>Context <span class="hljs-string">&#x27;argocd.tinychen.com&#x27;</span> updated<br><br><span class="hljs-comment"># 随即修改密码</span><br>$ argocd account update-password<br>*** Enter password of currently logged <span class="hljs-keyword">in</span> user (admin):<br>*** Enter new password <span class="hljs-keyword">for</span> user admin:<br>*** Confirm new password <span class="hljs-keyword">for</span> user admin:<br>Password updated<br>Context <span class="hljs-string">&#x27;argocd.tinychen.com&#x27;</span> updated<br><br><span class="hljs-comment"># 随后再次退出然后即可使用新密码进行重新登录</span><br>$ argocd <span class="hljs-built_in">logout</span> argocd.tinychen.com<br>Logged out from <span class="hljs-string">&#x27;argocd.tinychen.com&#x27;</span><br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>argocd cli的配置文件默认存储在<code>~/.config/argocd/config</code>目录下</p>
</blockquote>
<h1 id="7、集群配置"><a href="#7、集群配置" class="headerlink" title="7、集群配置"></a>7、集群配置</h1><p>argocd原生是支持同时管理多个集群的，同时因为argocd是部署在K8S集群中，所以argocd本身所处的集群默认是存在配置中的。我们可以通过CLI或者webUI来查看默认的集群，需要注意的是如果还没有在集群中部署应用的话，argocd是不会主动去探测集群的状态的。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd cluster list<br>SERVER                          NAME        VERSION  STATUS   MESSAGE                                                  PROJECT<br>https://kubernetes.default.svc  in-cluster           Unknown  Cluster has no applications and is not being monitored.<br></code></pre></div></td></tr></table></figure>

<p>添加新集群只能通过CLI来进行操作，webUI可以对集群进行重命名和删除等操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl config get-contexts -o name --kubeconfig /root/k8s-90-config<br>kubernetes-admin@kubernetes<br></code></pre></div></td></tr></table></figure>

<p>将集群添加到argocd之后会在集群中添加一个名为<code>argocd-manager</code>的<code>ServiceAccount</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd cluster add kubernetes-admin@kubernetes --kubeconfig /root/k8s-90-config --name k8s-90-cluster<br>WARNING: This will create a service account `argocd-manager` on the cluster referenced by context `kubernetes-admin@kubernetes` with full cluster level privileges. Do you want to <span class="hljs-built_in">continue</span> [y/N]? y<br>INFO[0003] ServiceAccount <span class="hljs-string">&quot;argocd-manager&quot;</span> created <span class="hljs-keyword">in</span> namespace <span class="hljs-string">&quot;kube-system&quot;</span><br>INFO[0003] ClusterRole <span class="hljs-string">&quot;argocd-manager-role&quot;</span> created<br>INFO[0003] ClusterRoleBinding <span class="hljs-string">&quot;argocd-manager-role-binding&quot;</span> created<br>INFO[0008] Created bearer token secret <span class="hljs-keyword">for</span> ServiceAccount <span class="hljs-string">&quot;argocd-manager&quot;</span><br>Cluster <span class="hljs-string">&#x27;https://10.31.90.0:8443&#x27;</span> added<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>大部分k8s默认生成的kubeconfig文件中的集群名都是kubernetes-admin@kubernetes，这对多集群管理稍有不便，如果想要单独指定在argocd中的集群名称可以在导入的时候使用–name 参数</p>
</blockquote>
<p>添加完成后可以查看到集群，但是由于尚未部署app，所以目前状态也并未同步</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd cluster list<br>SERVER                          NAME            VERSION  STATUS  MESSAGE  PROJECT<br>https://10.31.90.0:8443         k8s-90-cluster<br>https://kubernetes.default.svc  in-cluster<br></code></pre></div></td></tr></table></figure>

<h1 id="8、配置git仓库"><a href="#8、配置git仓库" class="headerlink" title="8、配置git仓库"></a>8、配置git仓库</h1><p>argocd中的git仓库和repo是一对多的关系，也就是说一个git仓库可以用于创建多个app，所以这里我们需要先配置git仓库。</p>
<blockquote>
<p>特别注意，<code>Project</code>在创建成功之后是无法修改的。如果想要使用project对多个项目进行管理，建议先创建project，再配置git仓库，最后配置apps</p>
</blockquote>
<p>如果有比较大量的git仓库存储需求，建议考虑自行搭建一个gitlab服务器，当然使用公共的gitlab、github和helm仓库等都是可以的。</p>
<p>argocd支持多种拉取仓库的方式，下面我们主要介绍https和ssh这两种较为常见的方式。</p>
<h2 id="8-1-通过https连接仓库"><a href="#8-1-通过https连接仓库" class="headerlink" title="8.1 通过https连接仓库"></a>8.1 通过https连接仓库</h2><p>https方式连接一般比较简单，常用于拉取一些公共git仓库。如下面示范的拉取argocd官方的git仓库作为示例：</p>
<p><img src="https://resource.tinychen.com/202305081133935.png" srcset="/img/loading.gif" lazyload></p>
<p>创建成功后我们可以在UI中看到该仓库的状态为Successful。</p>
<p><img src="https://resource.tinychen.com/202305081134177.png" srcset="/img/loading.gif" lazyload></p>
<p>在CLI中也能看到详细的状态信息。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd repo list<br>TYPE  NAME  REPO                                             INSECURE  OCI    LFS    CREDS  STATUS      MESSAGE  PROJECT<br>git         https://github.com/argoproj/argocd-example-apps  <span class="hljs-literal">false</span>     <span class="hljs-literal">false</span>  <span class="hljs-literal">false</span>  <span class="hljs-literal">false</span>  Successful           default<br></code></pre></div></td></tr></table></figure>

<blockquote>
<p>当然https的拉取方式也是可以配置用户名密码已经TLS双向认证等多种限制手段的。</p>
</blockquote>
<h2 id="8-2-通过ssh连接仓库"><a href="#8-2-通过ssh连接仓库" class="headerlink" title="8.2 通过ssh连接仓库"></a>8.2 通过ssh连接仓库</h2><p>首先我们生成一个密钥对，这个密钥对用来给git仓库添加权限</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ssh-keygen -C argocd@argocd.tinychen.com -f ~/.ssh/argocd<br></code></pre></div></td></tr></table></figure>

<p>接着我们为对应的git仓库创建对应的<code>depoly keys</code>，<code>depoly keys</code>的详细说明可以参考gitlab的<a target="_blank" rel="noopener" href="https://gitlab.tinychen.com/help/user/project/deploy_keys/index">官方文档</a>。<code>depoly keys</code>可以在gitlab的仓库的<code>Settings -&gt; Repository -&gt; Deploy keys</code>找到，然后把刚刚生成的key里面的公钥放进去即可，至于过期时间（<code>Expiration date</code>）则根据自己的实际需要进行配置，留空则为无限制。</p>
<p><img src="https://resource.tinychen.com/202305081132468.png" srcset="/img/loading.gif" lazyload></p>
<p>随后我们在argocd的webui节面创建一个repo，这里需要注意如果使用的是ssh并且端口不是默认的22，需要在URL中带上具体的端口信息。如图所示就指定了SSH的端口为9022。</p>
<p><img src="https://resource.tinychen.com/202305081134723.png" srcset="/img/loading.gif" lazyload></p>
<p>argocd在部署的时候自带了常用的几个网站的<code>ssh-known-hosts</code>并存储在<code>argocd-ssh-known-hosts-cm</code>这个<code>configmap</code>中</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get cm -n argocd argocd-ssh-known-hosts-cm<br>NAME                        DATA   AGE<br>argocd-ssh-known-hosts-cm   1      25h<br></code></pre></div></td></tr></table></figure>

<p>如果我们使用的是自建的gitlab服务器，建议勾选<code>Skip server verification</code>这个参数，或者将对应的<code>ssh-known-hosts</code>添加到<code>argocd-ssh-known-hosts-cm</code>这个<code>configmap</code>中，否则在同步git仓库的时候容易出现报错。</p>
<blockquote>
<p>也可以在webUI中的<code>Settings</code>-&gt;<code>Repository certificates and known hosts</code>中配置<code>ssh-known-hosts</code>和<code>TLS Certificate</code></p>
</blockquote>
<p><img src="https://resource.tinychen.com/202305081134204.png" srcset="/img/loading.gif" lazyload></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ argocd repo list<br>TYPE  NAME              REPO                                                        INSECURE  OCI    LFS    CREDS  STATUS      MESSAGE  PROJECT<br>git                     https://github.com/argoproj/argocd-example-apps             <span class="hljs-literal">false</span>     <span class="hljs-literal">false</span>  <span class="hljs-literal">false</span>  <span class="hljs-literal">false</span>  Successful           default<br>git   k8s-90-manifests  git@gitlab.tinychen.com:9022:tinychen/k8s-90-manifests.git  <span class="hljs-literal">true</span>      <span class="hljs-literal">false</span>  <span class="hljs-literal">true</span>   <span class="hljs-literal">false</span>  Successful           default<br></code></pre></div></td></tr></table></figure>



<h1 id="9、配置app"><a href="#9、配置app" class="headerlink" title="9、配置app"></a>9、配置app</h1><p>完成上面的所有步骤之后，我们可以开始配置最终的应用了。</p>
<ul>
<li>先来看基础配置<code>Application Name</code>和<code>Project Name</code>都是对应argocd中的参数，也是对应我们前面部署的两个crd</li>
<li><code>SYNC POLICY</code>可以选择自动同步还是手动同步</li>
<li><code>PRUNE RESOURCES</code>可以选择是否删除在git中移除的资源，如某个git版本中创建了一个svc，随后又删除了，如果不勾选该选项，则argocd不会自动删除该svc</li>
<li><code>SELF HEAL</code>可以理解为自愈，即检测到定义的资源状态和git中不一致的时候，是否自动同步为一致；如git中定义副本数为10，随后手动扩容至20但并未修改git中的配置文件，勾选这一项则会触发argocd自动将副本数缩减回10</li>
<li><code>SKIP SCHEMA VALIDATION</code>跳过语法检查，个人不建议开启</li>
<li><code>AUTO-CREATE NAMESPACE</code>可以设置如果对应的namespace不存在的话是否自动创建</li>
<li><code>APPLY OUT OF SYNC ONLY</code>类似于增量部署而不是全量部署，仅部署和git版本中不一样的资源，而不是全部重新部署一次，可以降低K8S集群的压力</li>
<li><code>REPLACE</code>会将部署的命令从默认的<code>kubectl apply</code>变更为<code>kubectl replace/create</code>，可以解决部分资源修改之后无法直接apply部署的问题，同时也有可能会导致资源的重复创建</li>
<li><code>RETRY</code>可以设定部署失败后重试的次数和频率</li>
</ul>
<blockquote>
<p>关于sync options的完整参数解析可以查看官方的文档<a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/%EF%BC%8C%E8%BF%99%E9%87%8C%E5%8F%AA%E6%8C%91%E4%BA%86%E4%B8%80%E4%BA%9B%E4%B8%AA%E4%BA%BA%E5%B8%B8%E7%94%A8%E4%B8%94%E7%86%9F%E6%82%89%E7%9A%84%E5%8F%82%E6%95%B0%E8%BF%9B%E8%A1%8C%E4%BB%8B%E7%BB%8D%EF%BC%8C%E5%A6%82%E6%9E%9C%E4%B8%8D%E7%9F%A5%E9%81%93%E4%B8%80%E4%B8%AA%E5%8F%82%E6%95%B0%E7%9A%84%E4%BD%9C%E7%94%A8%E6%98%AF%E4%BB%80%E4%B9%88%EF%BC%8C%E5%BB%BA%E8%AE%AE%E4%BF%9D%E6%8C%81%E9%BB%98%E8%AE%A4%E5%80%BC%E3%80%82">https://argo-cd.readthedocs.io/en/latest/user-guide/sync-options/，这里只挑了一些个人常用且熟悉的参数进行介绍，如果不知道一个参数的作用是什么，建议保持默认值。</a></p>
</blockquote>
<p><img src="https://resource.tinychen.com/202307131705943.png" srcset="/img/loading.gif" lazyload></p>
<p><code>SOURCE</code>这里主要用于指定git仓库、对应的分支及具体的子目录</p>
<p><img src="https://resource.tinychen.com/202307131705655.png" srcset="/img/loading.gif" lazyload></p>
<p><code>DESTINATION</code>这里用来指定部署的K8S集群和namespace。</p>
<p><img src="https://resource.tinychen.com/202307131702081.png" srcset="/img/loading.gif" lazyload></p>
<p><code>Directory</code>这一栏里面有个<code>DIRECTORY RECURSE</code>参数，勾选之后会递归识别子目录下面的文件。</p>
<p><img src="https://resource.tinychen.com/202307131702359.png" srcset="/img/loading.gif" lazyload></p>
<blockquote>
<p>这里还可以下拉变更为helm、Kustomize、Plugin等其他配置</p>
</blockquote>
<p>部署完成之后我们就可以使用argocd来管理对应的应用了</p>
<p><img src="https://resource.tinychen.com/202307131658800.png" srcset="/img/loading.gif" lazyload></p>
<h1 id="10、配置git-webhooks"><a href="#10、配置git-webhooks" class="headerlink" title="10、配置git webhooks"></a>10、配置git webhooks</h1><p>ArgoCD每三分钟会拉取一次git仓库的内容以检测manifests的变化。如果想要消除这个由轮询机制带来的三分钟延迟，我们可以考虑使用webhook来进行通知。Argo CD 支持来自 GitHub、GitLab、Bitbucket、Bitbucket Server 和 Gogs 的 Git webhook 通知，官方提供了<a target="_blank" rel="noopener" href="https://argo-cd.readthedocs.io/en/latest/operator-manual/webhook/">基于Github配置webhook事件的教程</a>，我们这里使用自建的gitlab来进行配置。</p>
<p>首先我们找到用来测试的git仓库，在gitlab界面中找到<code>Settings-&gt;Webhooks</code>，然后按照下面红框所示的进行操作。</p>
<ul>
<li>URL这里一般都是配置自己argocd的访问域名再加上<code>/api/webhook</code>后缀，注意需要配置https访问</li>
<li>注意这里面的<code>Secret token</code>可以用来增强webhook接口的安全性，大家可以根据自己的实际需求来进行配置。token这里我配置了一串字符串，注意要保存下来，后面还需要在argocd侧进行配置</li>
<li>Trigger这里只需要勾选Push events即可，因为我们只需要在有人push变更到git仓库之后，gitlab自动去触发webhook接口调用argocd来完成更新</li>
</ul>
<p><img src="https://resource.tinychen.com/202305081210029.png" srcset="/img/loading.gif" lazyload></p>
<p>SSL认证这里建议默认勾选，argocd默认都是走https请求的。</p>
<p><img src="https://resource.tinychen.com/202307131658454.png" srcset="/img/loading.gif" lazyload></p>
<p>添加完成之后可以看到这个project里面就新增了一个<code>Project Hooks</code>，这时候还不能正常调用，我们还需要到argocd里面配置前面提到的<code>Secret token</code>。</p>
<p><img src="https://resource.tinychen.com/202305081220785.png" srcset="/img/loading.gif" lazyload></p>
<p>argocd使用的<code>secret</code>都以<code>secrets</code>的形式存储在K8S中，我们这里主要用到的是<code>argocd-secret</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl edit secrets -n argocd argocd-secret -o yaml<br></code></pre></div></td></tr></table></figure>

<p>我们在里面手动添加一个<code>stringData</code>，然后把前面的<code>Secret token</code>贴进去，格式类似下面的示范即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">argocd-secret</span><br>    <span class="hljs-attr">app.kubernetes.io/part-of:</span> <span class="hljs-string">argocd</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">argocd-secret</span><br><span class="hljs-attr">type:</span> <span class="hljs-string">Opaque</span><br><span class="hljs-attr">stringData:</span><br>  <span class="hljs-comment"># gitlab webhook secret</span><br>  <span class="hljs-attr">webhook.gitlab.secret:</span> <span class="hljs-string">vbdUUDkHszh35VZ6</span><br></code></pre></div></td></tr></table></figure>

<p>完成之后我们再回到gitlab上面，点击Test，选择Push events，如果这时候有下图所示的返回信息则说明已经配置成功且webhook可以正常工作。</p>
<p><img src="https://resource.tinychen.com/202305081225663.png" srcset="/img/loading.gif" lazyload></p>
<p>最后我们可以手动测试一下webhook的效果：随意编辑一个yaml文件，更改其中的副本数，<code>git push</code>之后查看argocd的webUI界面确定是否会即可生效即可完成测试。</p>
<blockquote>
<p>这里不一定需要修改副本数，也可以修改资源配额等其他比较明显能触发pod重建之类的参数，确保我们能比较轻松明显地在argocd上面查看到变化的内容。</p>
</blockquote>
<p>最后要提到的是：不太建议通过校对git的版本号来进确定argocd的同步状态，因为不管是<code>SYNC STATUS</code>还是<code>LAST SYNC</code>里面的版本号都不一定是该git仓库对应分支的最新版本号，正常情况下的版本号应该是涉及到这个argocd的app里面所需要用到的文件的最新的版本号；当然我们也可以通过手动点击sync按钮来触发同步操作，这时候<code>SYNC STATUS</code>和<code>LAST SYNC</code>里面的版本号就都同步到最新的git版本（尽管这时候可能并不需要进行K8S的同步操作）。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/cloudnative/">cloudnative</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/k8s/">k8s</a>
                    
                      <a class="hover-with-bg" href="/tags/argocd/">argocd</a>
                    
                      <a class="hover-with-bg" href="/tags/git/">git</a>
                    
                      <a class="hover-with-bg" href="/tags/gitops/">gitops</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20230303-anycast-overview/">
                        <span class="hidden-mobile">Anycast概览</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>since 2017 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备18140640号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-166769908-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>

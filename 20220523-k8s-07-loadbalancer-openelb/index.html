

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文主要在k8s原生集群上部署v0.4.4版本的OpenELB作为k8s的LoadBalancer，主要涉及OpenELB的Layer2模式和BGP模式两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。 文中使用的k8s集群是在CentOS7系统上基于docker和calico组件部署v1.23.6版本，此前写的一些关于k8s基础知识和集群搭建的一些方案，有需要的同学可">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s系列07-负载均衡器之OpenELB">
<meta property="og:url" content="https://tinychen.com/20220523-k8s-07-loadbalancer-openelb/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio - 互联网技术学习工作经验分享">
<meta property="og:description" content="本文主要在k8s原生集群上部署v0.4.4版本的OpenELB作为k8s的LoadBalancer，主要涉及OpenELB的Layer2模式和BGP模式两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。 文中使用的k8s集群是在CentOS7系统上基于docker和calico组件部署v1.23.6版本，此前写的一些关于k8s基础知识和集群搭建的一些方案，有需要的同学可">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/202205240632265.jpg">
<meta property="article:published_time" content="2022-05-23T14:00:00.000Z">
<meta property="article:modified_time" content="2022-05-23T14:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="loadbalance">
<meta property="article:tag" content="metallb">
<meta property="article:tag" content="openelb">
<meta property="article:tag" content="purelb">
<meta property="article:tag" content="bgp">
<meta property="article:tag" content="quagga">
<meta property="article:tag" content="frr">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/202205240632265.jpg">
  
  
  <title>k8s系列07-负载均衡器之OpenELB - TinyChen&#39;s Studio - 互联网技术学习工作经验分享</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/dracula.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/fluid-extention.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio - 互联网技术学习工作经验分享" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://resource.tinychen.com/202205240632926.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="k8s系列07-负载均衡器之OpenELB">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-23 22:00" pubdate>
        May 23, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      28k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">k8s系列07-负载均衡器之OpenELB</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：May 23, 2022 pm
                
              </p>
            
            <div class="markdown-body">
              <p>本文主要在k8s原生集群上部署<code>v0.4.4</code>版本的<code>OpenELB</code>作为k8s的<code>LoadBalancer</code>，主要涉及<strong>OpenELB</strong>的<strong>Layer2模式</strong>和<strong>BGP模式</strong>两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。</p>
<p>文中使用的k8s集群是在CentOS7系统上基于<code>docker</code>和<code>calico</code>组件部署<code>v1.23.6</code>版本，此前写的一些关于k8s基础知识和集群搭建的一些<a href="https://tinychen.com/tags/k8s/">方案</a>，有需要的同学可以看一下。</p>
<span id="more"></span>

<h1 id="1、工作原理"><a href="#1、工作原理" class="headerlink" title="1、工作原理"></a>1、工作原理</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p>OpenELB 是一个开源的云原生负载均衡器实现，可以在基于裸金属服务器、边缘以及虚拟化的 Kubernetes 环境中使用 LoadBalancer 类型的 Service 对外暴露服务。OpenELB 项目最初由 <a target="_blank" rel="noopener" href="https://kubesphere.io/">KubeSphere 社区</a> 发起，目前已作为 CNCF <a target="_blank" rel="noopener" href="https://www.cncf.io/sandbox-projects/">沙箱项目</a> 加入 CNCF 基金会，由 OpenELB 开源社区维护与支持。</p>
<p><strong>与MetalLB类似，OpenELB也拥有两种主要工作模式：Layer2模式和BGP模式。OpenELB的BGP模式目前暂不支持IPv6。</strong></p>
<p><strong>无论是Layer2模式还是BGP模式，核心思路都是通过某种方式将特定VIP的流量引到k8s集群中，然后再通过kube-proxy将流量转发到后面的特定服务。</strong></p>
<h2 id="1-2-Layer2模式"><a href="#1-2-Layer2模式" class="headerlink" title="1.2 Layer2模式"></a>1.2 Layer2模式</h2><blockquote>
<p>Layer2模式需要我们的k8s集群基础环境支持发送anonymous ARP/NDP packets。因为OpenELB是针对裸金属服务器设计的，因此如果是在云环境中部署，需要注意是否满足条件。</p>
</blockquote>
<p>下图来自<a target="_blank" rel="noopener" href="https://openelb.github.io/docs/concepts/layer-2-mode/">OpenELB官方</a>，这里简单阐述一下Layer2模式的工作原理：</p>
<p><img src="https://resource.tinychen.com/202205231624905.jpeg" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>图中有一个类型为LoadBalancer的Service，其VIP为192.168.0.91（<strong>和k8s的节点相同网段</strong>），后端有两个pod（分别为pod1和pod2）</li>
<li>安装在 Kubernetes 集群中的 OpenELB 随机选择一个节点（图中为 worker 1）来处理 Service 请求。当局域网中出现arp request数据包来查询192.168.0.91的mac地址的时候，OpenELB会进行回应（使用 worker 1 的 MAC 地址），此时路由器（也可能是交换机）将 Service 的VIP 192.168.0.91和 worker 1 的 MAC 地址绑定，之后所有请求到192.168.0.91的数据包都会被转发到worker1上</li>
<li>Service 流量到达 worker 1 后， worker 1 上的 kube-proxy 将流量转发到后端的两个pod进行负载均衡，这些pod不一定在work1上</li>
</ul>
<p>主要的工作流程就如同上面描述的一般，但是还有几个需要额外注意的点：</p>
<ul>
<li>如果 worker 1 出现故障，OpenELB 会重新向路由器发送 APR/NDP 数据包，将 Service IP 地址映射到 worker 2 的 MAC 地址，Service 流量切换到 worker 2</li>
<li>主备切换过程并不是瞬间完成的，中间会产生一定时间的服务中断（具体多久官方也没说，实际上应该是却决于检测到节点宕机的时间加上重新选主的时间）</li>
<li>如果集群中已经部署了多个 openelb-manager 副本，OpenELB 使用 Kubernetes 的领导者选举特性算法来进行选主，从而确保只有一个副本响应 ARP/NDP 请求</li>
</ul>
<h2 id="1-3-BGP模式"><a href="#1-3-BGP模式" class="headerlink" title="1.3 BGP模式"></a>1.3 BGP模式</h2><p>OpenELB的BGP模式使用的是<a target="_blank" rel="noopener" href="https://github.com/osrg/gobgp">gobgp</a>实现的BGP协议，通过使用BGP协议和路由器建立BGP连接并实现ECMP负载均衡，从而实现高可用的LoadBalancer。</p>
<p>我们还是借用<a target="_blank" rel="noopener" href="https://openelb.github.io/docs/concepts/bgp-mode/">官网的图</a>来解释一下这个流程，注意BGP模式暂不支持IPv6。</p>
<p><img src="https://resource.tinychen.com/202205231638835.jpeg" srcset="/img/loading.gif" lazyload></p>
<ul>
<li>图中有一个类型为LoadBalancer的Service，其VIP为172.22.0.2（<strong>和k8s的节点不同网段</strong>），后端有两个pod（分别为pod1和pod2）</li>
<li>安装在 Kubernetes 集群中的 OpenELB 与 BGP 路由器建立 BGP 连接，并将去往 172.22.0.2 的路由发布到 BGP 路由器，在配置得当的情况下，路由器上面的路由表可以看到 172.22.0.2 这个VIP的下一条有多个节点（均为k8s的宿主机节点）</li>
<li>当外部客户端机器尝试访问 Service 时，BGP 路由器根据从 OpenELB 获取的路由，在 master、worker 1 和 worker 2 节点之间进行流量负载均衡。Service 流量到达一个节点后，该节点上的 kube-proxy 将流量转发到后端的两个pod进行负载均衡，这些pod不一定在该节点上</li>
</ul>
<h1 id="2、Layer2-Mode"><a href="#2、Layer2-Mode" class="headerlink" title="2、Layer2 Mode"></a>2、Layer2 Mode</h1><h2 id="2-1-配置ARP参数"><a href="#2-1-配置ARP参数" class="headerlink" title="2.1 配置ARP参数"></a>2.1 配置ARP参数</h2><p>部署Layer2模式需要把k8s集群中的ipvs配置打开<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/kube-proxy-config.v1alpha1/"><code>strictARP</code></a>，开启之后k8s集群中的<code>kube-proxy</code>会停止响应<code>kube-ipvs0</code>网卡之外的其他网卡的arp请求，而由MetalLB接手处理。</p>
<p><code>strict ARP</code>开启之后相当于把 将 <code>arp_ignore</code> 设置为 1 并将 <code>arp_announce</code> 设置为 2 启用严格的 ARP，这个原理和LVS中的DR模式对RS的配置一样，可以参考之前的<a href="https://tinychen.com/20200427-lvs-principle-introduction/#6%E3%80%81ARP-in-LVS">文章中的解释</a>。</p>
<blockquote>
<p>strict ARP configure arp_ignore and arp_announce to avoid answering ARP queries from kube-ipvs0 interface</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 查看kube-proxy中的strictARP配置</span><br>$ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP<br>      strictARP: <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># 手动修改strictARP配置为true</span><br>$ kubectl edit configmap -n kube-system kube-proxy<br>configmap/kube-proxy edited<br><br><span class="hljs-comment"># 使用命令直接修改并对比不同</span><br>$ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e <span class="hljs-string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | kubectl diff -f - -n kube-system<br><br><span class="hljs-comment"># 确认无误后使用命令直接修改并生效</span><br>$ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e <span class="hljs-string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | kubectl apply -f - -n kube-system<br><br><span class="hljs-comment"># 重启kube-proxy确保配置生效</span><br>$ kubectl rollout restart ds kube-proxy -n kube-system<br><br><span class="hljs-comment"># 确认配置生效</span><br>$ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP<br>      strictARP: <span class="hljs-literal">true</span><br><br></code></pre></div></td></tr></table></figure>

<h2 id="2-2-部署openelb"><a href="#2-2-部署openelb" class="headerlink" title="2.2 部署openelb"></a>2.2 部署openelb</h2><p>这里我们还是使用yaml进行部署，官方把所有部署的资源整合到了一个文件中，我们还是老规矩先下载到本地再进行部署</p>
<figure class="highlight stylus"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs stylus">$ wget https:<span class="hljs-comment">//raw.githubusercontent.com/openelb/openelb/master/deploy/openelb.yaml</span><br><br>$ kubectl apply -f openelb<span class="hljs-selector-class">.yaml</span><br>namespace/openelb-system created<br>customresourcedefinition<span class="hljs-selector-class">.apiextensions</span><span class="hljs-selector-class">.k8s</span>.io/bgpconfs<span class="hljs-selector-class">.network</span><span class="hljs-selector-class">.kubesphere</span><span class="hljs-selector-class">.io</span> created<br>customresourcedefinition<span class="hljs-selector-class">.apiextensions</span><span class="hljs-selector-class">.k8s</span>.io/bgppeers<span class="hljs-selector-class">.network</span><span class="hljs-selector-class">.kubesphere</span><span class="hljs-selector-class">.io</span> created<br>customresourcedefinition<span class="hljs-selector-class">.apiextensions</span><span class="hljs-selector-class">.k8s</span>.io/eips<span class="hljs-selector-class">.network</span><span class="hljs-selector-class">.kubesphere</span><span class="hljs-selector-class">.io</span> created<br>serviceaccount/kube-keepalived-vip created<br>serviceaccount/openelb-admission created<br>role<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/leader-election-role created<br>role<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br>clusterrole<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/kube-keepalived-vip created<br>clusterrole<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br>clusterrole<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-manager-role created<br>rolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/leader-election-rolebinding created<br>rolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br>clusterrolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/kube-keepalived-vip created<br>clusterrolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br>clusterrolebinding<span class="hljs-selector-class">.rbac</span><span class="hljs-selector-class">.authorization</span><span class="hljs-selector-class">.k8s</span>.io/openelb-manager-rolebinding created<br>service/openelb-admission created<br>deployment.apps/openelb-manager created<br>job.batch/openelb-admission-create created<br>job.batch/openelb-admission-patch created<br>mutatingwebhookconfiguration<span class="hljs-selector-class">.admissionregistration</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br>validatingwebhookconfiguration<span class="hljs-selector-class">.admissionregistration</span><span class="hljs-selector-class">.k8s</span>.io/openelb-admission created<br></code></pre></div></td></tr></table></figure>

<p>接下来我们看看都部署了什么CRD资源，这几个CRD资源主要就是方便我们管理<code>openelb</code>，这也是OpenELB相对MetalLB的优势。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get crd<br>NAME                             CREATED AT<br>bgpconfs.network.kubesphere.io   2022-05-19T06:37:19Z<br>bgppeers.network.kubesphere.io   2022-05-19T06:37:19Z<br>eips.network.kubesphere.io       2022-05-19T06:37:19Z<br><br>$ kubectl get ns openelb-system -o wide<br>NAME             STATUS   AGE<br>openelb-system   Active   2m27s<br><br></code></pre></div></td></tr></table></figure>

<p>实际上主要工作的负载就是这两个<code>jobs.batch</code>和这一个<code>deployment</code></p>
<figure class="highlight pgsql"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs pgsql">$ kubectl <span class="hljs-keyword">get</span> pods -n openelb-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>                               READY   STATUS      RESTARTS   AGE<br>openelb-admission-<span class="hljs-keyword">create</span><span class="hljs-number">-57</span>tzm     <span class="hljs-number">0</span>/<span class="hljs-number">1</span>     Completed   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>m11s<br>openelb-admission-patch-j5pl4      <span class="hljs-number">0</span>/<span class="hljs-number">1</span>     Completed   <span class="hljs-number">0</span>          <span class="hljs-number">5</span>m11s<br>openelb-manager<span class="hljs-number">-5</span>cdc8697f9-h2wd6   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     Running     <span class="hljs-number">0</span>          <span class="hljs-number">5</span>m11s<br><br>$ kubectl <span class="hljs-keyword">get</span> deploy -n openelb-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>              READY   UP-<span class="hljs-keyword">TO</span>-<span class="hljs-type">DATE</span>   AVAILABLE   AGE<br>openelb-manager   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>     <span class="hljs-number">1</span>            <span class="hljs-number">1</span>           <span class="hljs-number">5</span>m38s<br><br>$ kubectl <span class="hljs-keyword">get</span> jobs.batch -n openelb-<span class="hljs-keyword">system</span><br><span class="hljs-type">NAME</span>                       COMPLETIONS   DURATION   AGE<br>openelb-admission-<span class="hljs-keyword">create</span>   <span class="hljs-number">1</span>/<span class="hljs-number">1</span>           <span class="hljs-number">11</span>s        <span class="hljs-number">11</span>m<br>openelb-admission-patch    <span class="hljs-number">1</span>/<span class="hljs-number">1</span>           <span class="hljs-number">12</span>s        <span class="hljs-number">11</span>m<br></code></pre></div></td></tr></table></figure>



<h2 id="2-3-创建EIP"><a href="#2-3-创建EIP" class="headerlink" title="2.3 创建EIP"></a>2.3 创建EIP</h2><p>接下来我们需要配置loadbalancerIP所在的网段资源，这里我们创建一个Eip对象来进行定义，后面对IP段的管理也是在这里进行。</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">network.kubesphere.io/v1alpha2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Eip</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-comment"># Eip 对象的名称。</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eip-layer2-pool</span><br><span class="hljs-attr">spec:</span><br>    <span class="hljs-comment"># Eip 对象的地址池</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.101</span><span class="hljs-number">-10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.200</span><br><br>    <span class="hljs-comment"># openELB的运行模式，默认为bgp</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">layer2</span><br><br>    <span class="hljs-comment"># OpenELB 在其上侦听 ARP/NDP 请求的网卡。该字段仅在protocol设置为时有效layer2。</span><br>    <span class="hljs-attr">interface:</span> <span class="hljs-string">eth0</span><br><br>    <span class="hljs-comment"># 指定是否禁用 Eip 对象</span><br>    <span class="hljs-comment"># false表示可以继续分配</span><br>    <span class="hljs-comment"># true表示不再继续分配</span><br>    <span class="hljs-attr">disable:</span> <span class="hljs-literal">false</span><br>    <br><span class="hljs-attr">status:</span><br><br>    <span class="hljs-comment"># 指定 Eip 对象中的IP地址是否已用完。</span><br>    <span class="hljs-attr">occupied:</span> <span class="hljs-literal">false</span><br><br>    <span class="hljs-comment"># 指定 Eip 对象中有多少个 IP 地址已分配给服务。</span><br>    <span class="hljs-comment"># 直接留空，系统会自动生成</span><br>    <span class="hljs-attr">usage:</span> <br><br>    <span class="hljs-comment"># Eip 对象中的 IP 地址总数。</span><br>    <span class="hljs-attr">poolSize:</span> <span class="hljs-number">100</span><br><br>    <span class="hljs-comment"># 指定使用的 IP 地址和使用 IP 地址的服务。服务以Namespace/Service name格式显示（例如，default/test-svc）。</span><br>    <span class="hljs-comment"># 直接留空，系统会自动生成</span><br>    <span class="hljs-attr">used:</span> <br><br>    <span class="hljs-comment"># Eip 对象中的第一个 IP 地址。</span><br>    <span class="hljs-attr">firstIP:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.101</span><br>    <span class="hljs-comment"># Eip 对象中的最后一个 IP 地址。</span><br>    <span class="hljs-attr">lastIP:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.200</span><br><br>    <span class="hljs-attr">ready:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 指定IP协议栈是否为 IPv4。目前，OpenELB 仅支持 IPv4，其值只能是true.</span><br>    <span class="hljs-attr">v4:</span> <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>

<p>配置完成后我们直接部署即可</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f openelb/openelb-eip.yaml<br>eip.network.kubesphere.io/eip-layer2-pool created<br></code></pre></div></td></tr></table></figure>

<p>部署完成后检查eip的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get eip<br>NAME              CIDR                        USAGE   TOTAL<br>eip-layer2-pool   10.31.88.101-10.31.88.200           100<br></code></pre></div></td></tr></table></figure>



<h2 id="2-4-创建测试服务"><a href="#2-4-创建测试服务" class="headerlink" title="2.4 创建测试服务"></a>2.4 创建测试服务</h2><p>然后我们创建对应的服务</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Namespace</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-quic</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">4</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">tinychen777/nginx-quic:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br> <br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb2-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb3-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br><br><br></code></pre></div></td></tr></table></figure>

<p>然后我们检查部署状态：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f nginx-quic-lb.yaml<br>namespace/nginx-quic unchanged<br>deployment.apps/nginx-lb created<br>service/nginx-lb-service created<br>service/nginx-lb2-service created<br>service/nginx-lb3-service created<br><br>$ kubectl get svc -n nginx-quic<br>NAME                 TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)        AGE<br>nginx-lb-service     LoadBalancer   10.88.17.248   10.31.88.101   80:30643/TCP   58m<br>nginx-lb2-service    LoadBalancer   10.88.13.220   10.31.88.102   80:31114/TCP   58m<br>nginx-lb3-service    LoadBalancer   10.88.18.110   10.31.88.103   80:30485/TCP   58m<br></code></pre></div></td></tr></table></figure>

<p>此时我们再查看eip的状态可以看到新部署的三个LoadBalancer服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get eip<br>NAME              CIDR                        USAGE   TOTAL<br>eip-layer2-pool   10.31.88.101-10.31.88.200   3       100<br><br>[root@tiny-calico-master-88-1 tiny-calico]<span class="hljs-comment"># kubectl get eip -o yaml</span><br>apiVersion: v1<br>items:<br>- apiVersion: network.kubesphere.io/v1alpha2<br>  kind: Eip<br>  metadata:<br>    annotations:<br>      kubectl.kubernetes.io/last-applied-configuration: |<br>        &#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;network.kubesphere.io/v1alpha2&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Eip&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;annotations&quot;</span>:&#123;&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;eip-layer2-pool&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;address&quot;</span>:<span class="hljs-string">&quot;10.31.88.101-10.31.88.200&quot;</span>,<span class="hljs-string">&quot;disable&quot;</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>&#125;,<span class="hljs-string">&quot;status&quot;</span>:&#123;<span class="hljs-string">&quot;firstIP&quot;</span>:<span class="hljs-string">&quot;10.31.88.101&quot;</span>,<span class="hljs-string">&quot;lastIP&quot;</span>:<span class="hljs-string">&quot;10.31.88.200&quot;</span>,<span class="hljs-string">&quot;occupied&quot;</span>:<span class="hljs-literal">false</span>,<span class="hljs-string">&quot;poolSize&quot;</span>:100,<span class="hljs-string">&quot;ready&quot;</span>:<span class="hljs-literal">true</span>,<span class="hljs-string">&quot;usage&quot;</span>:1,<span class="hljs-string">&quot;used&quot;</span>:&#123;<span class="hljs-string">&quot;10.31.88.101&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>&#125;,<span class="hljs-string">&quot;v4&quot;</span>:<span class="hljs-literal">true</span>&#125;&#125;<br>    creationTimestamp: <span class="hljs-string">&quot;2022-05-19T08:21:58Z&quot;</span><br>    finalizers:<br>    - finalizer.ipam.kubesphere.io/v1alpha1<br>    generation: 2<br>    name: eip-layer2-pool<br>    resourceVersion: <span class="hljs-string">&quot;1623927&quot;</span><br>    uid: 9b091518-7b64-43ae-9fd4-abaf50563160<br>  spec:<br>    address: 10.31.88.101-10.31.88.200<br>    interface: eth0<br>    protocol: layer2<br>  status:<br>    firstIP: 10.31.88.101<br>    lastIP: 10.31.88.200<br>    poolSize: 100<br>    ready: <span class="hljs-literal">true</span><br>    usage: 3<br>    used:<br>      10.31.88.101: nginx-quic/nginx-lb-service<br>      10.31.88.102: nginx-quic/nginx-lb2-service<br>      10.31.88.103: nginx-quic/nginx-lb3-service<br>    v4: <span class="hljs-literal">true</span><br>kind: List<br>metadata:<br>  resourceVersion: <span class="hljs-string">&quot;&quot;</span><br>  selfLink: <span class="hljs-string">&quot;&quot;</span><br></code></pre></div></td></tr></table></figure>

<h2 id="2-5-关于nodeport"><a href="#2-5-关于nodeport" class="headerlink" title="2.5 关于nodeport"></a>2.5 关于nodeport</h2><p>openELB似乎并不支持<code>allocateLoadBalancerNodePorts</code>字段，在指定了<code>allocateLoadBalancerNodePorts</code>为<code>false</code>的情况下还是为服务创建了nodeport，查看部署后的配置可以发现参数被修改回了<code>true</code>，并且无法修改为<code>false</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[root@tiny-calico-master-88-1 tiny-calico]<span class="hljs-comment"># kubectl get svc -n nginx-quic</span><br>NAME                 TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)        AGE<br>nginx-lb-service     LoadBalancer   10.88.17.248   10.31.88.101   80:30643/TCP   106m<br>nginx-lb2-service    LoadBalancer   10.88.13.220   10.31.88.102   80:31114/TCP   106m<br>nginx-lb3-service    LoadBalancer   10.88.18.110   10.31.88.113   80:30485/TCP   106m<br><br>[root@tiny-calico-master-88-1 tiny-calico]<span class="hljs-comment"># kubectl get svc -n nginx-quic nginx-lb-service -o yaml | grep &quot;allocateLoadBalancerNodePorts:&quot;</span><br>  allocateLoadBalancerNodePorts: <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>



<h2 id="2-6-关于VIP"><a href="#2-6-关于VIP" class="headerlink" title="2.6 关于VIP"></a>2.6 关于VIP</h2><h3 id="2-6-1-如何查找VIP"><a href="#2-6-1-如何查找VIP" class="headerlink" title="2.6.1 如何查找VIP"></a>2.6.1 如何查找VIP</h3><p>Layer2模式下，所有的k8s节点的kube-ipvs0接口上都会看到所有的VIP，因此确定VIP的节点还是和MetalLB一样，需要通过查看pod中的日志，或者是看arp表来确定</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl logs -f -n  openelb-system openelb-manager-5cdc8697f9-h2wd6<br>...省略一堆日志输出...<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1652949142.6426723,<span class="hljs-string">&quot;logger&quot;</span>:<span class="hljs-string">&quot;IPAM&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;assignIP&quot;</span>,<span class="hljs-string">&quot;args&quot;</span>:&#123;<span class="hljs-string">&quot;Key&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb3-service&quot;</span>,<span class="hljs-string">&quot;Addr&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-string">&quot;Eip&quot;</span>:<span class="hljs-string">&quot;eip-layer2-pool&quot;</span>,<span class="hljs-string">&quot;Protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;Unalloc&quot;</span>:<span class="hljs-literal">false</span>&#125;,<span class="hljs-string">&quot;result&quot;</span>:&#123;<span class="hljs-string">&quot;Addr&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-string">&quot;Eip&quot;</span>:<span class="hljs-string">&quot;eip-layer2-pool&quot;</span>,<span class="hljs-string">&quot;Protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;Sp&quot;</span>:&#123;&#125;&#125;,<span class="hljs-string">&quot;err&quot;</span>:null&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1652949142.65095,<span class="hljs-string">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;map ingress ip&quot;</span>,<span class="hljs-string">&quot;ingress&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-string">&quot;nodeIP&quot;</span>:<span class="hljs-string">&quot;10.31.88.1&quot;</span>,<span class="hljs-string">&quot;nodeMac&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1652949142.6509972,<span class="hljs-string">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;send gratuitous arp packet&quot;</span>,<span class="hljs-string">&quot;eip&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-string">&quot;nodeIP&quot;</span>:<span class="hljs-string">&quot;10.31.88.1&quot;</span>,<span class="hljs-string">&quot;hwAddr&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1652949142.6510363,<span class="hljs-string">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;send gratuitous arp packet&quot;</span>,<span class="hljs-string">&quot;eip&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-string">&quot;nodeIP&quot;</span>:<span class="hljs-string">&quot;10.31.88.1&quot;</span>,<span class="hljs-string">&quot;hwAddr&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:1652949142.6849823,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;setup openelb service&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb3-service&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>查看arp表来确定MAC地址从而确定VIP所在的节点</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ip neigh  | grep 10.31.88.113<br>10.31.88.113 dev eth0 lladdr 52:54:00:74:eb:11 STALE<br>$ arp -a | grep 10.31.88.113<br>? (10.31.88.113) at 52:54:00:74:eb:11 [ether] on eth0<br></code></pre></div></td></tr></table></figure>

<h3 id="2-6-2-如何指定VIP"><a href="#2-6-2-如何指定VIP" class="headerlink" title="2.6.2 如何指定VIP"></a>2.6.2 如何指定VIP</h3><p>如果需要指定VIP，我们还是在service中修改<code>loadBalancerIP</code>字段从而指定VIP：</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb3-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">lb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">openelb</span><br>    <span class="hljs-attr">protocol.openelb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">layer2</span><br>    <span class="hljs-attr">eip.openelb.kubesphere.io/v1alpha2:</span> <span class="hljs-string">eip-layer2-pool</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-comment"># 使用 loadBalancerIP 字段从而指定VIP</span><br>  <span class="hljs-attr">loadBalancerIP:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.113</span><br></code></pre></div></td></tr></table></figure>

<p>修改完成之后我们重新部署，openelb会自动生效并且将服务的<code>EXTERNAL-IP</code>变更为新IP。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic -o wide<br>NAME                 TYPE           CLUSTER-IP     EXTERNAL-IP    PORT(S)        AGE     SELECTOR<br>nginx-lb-service     LoadBalancer   10.88.17.248   10.31.88.101   80:30643/TCP   18h     app=nginx-lb<br>nginx-lb2-service    LoadBalancer   10.88.13.220   10.31.88.102   80:31114/TCP   18h     app=nginx-lb<br>nginx-lb3-service    LoadBalancer   10.88.18.110   10.31.88.113   80:30485/TCP   18h     app=nginx-lb<br></code></pre></div></td></tr></table></figure>



<h2 id="2-7-Layer2-工作原理"><a href="#2-7-Layer2-工作原理" class="headerlink" title="2.7 Layer2 工作原理"></a>2.7 Layer2 工作原理</h2><p>我们查看pod的日志，可以看到更多的详细信息：</p>
<figure class="highlight json"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs json">$ kubectl logs -f -n  openelb-system openelb-manager<span class="hljs-number">-5</span>cdc8697f9-h2wd6<br>...省略一堆日志输出...<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950197.1421876</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.101&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:56:df:ae&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950496.9334905</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.102&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950497.1327593</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950497.1528928</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.101&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:56:df:ae&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950796.9339302</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.102&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950797.1334393</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.113&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:74:eb:11&quot;</span>&#125;<br>&#123;<span class="hljs-attr">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-attr">&quot;ts&quot;</span>:<span class="hljs-number">1652950797.1572392</span>,<span class="hljs-attr">&quot;logger&quot;</span>:<span class="hljs-string">&quot;arpSpeaker&quot;</span>,<span class="hljs-attr">&quot;msg&quot;</span>:<span class="hljs-string">&quot;got ARP request, sending response&quot;</span>,<span class="hljs-attr">&quot;interface&quot;</span>:<span class="hljs-string">&quot;eth0&quot;</span>,<span class="hljs-attr">&quot;ip&quot;</span>:<span class="hljs-string">&quot;10.31.88.101&quot;</span>,<span class="hljs-attr">&quot;senderIP&quot;</span>:<span class="hljs-string">&quot;10.31.254.250&quot;</span>,<span class="hljs-attr">&quot;senderMAC&quot;</span>:<span class="hljs-string">&quot;6c:b1:58:56:e9:d4&quot;</span>,<span class="hljs-attr">&quot;responseMAC&quot;</span>:<span class="hljs-string">&quot;52:54:00:56:df:ae&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>可以看到<code>openelb-manager</code>会持续的监听局域网中的<code>ARP request</code>请求，当遇到请求的IP是自己IP池里面已经使用的VIP时会主动响应。如果<code>openelb-manager</code>存在多个副本的时候，它们会先使用k8s的选主算法来进行选主，然后再由选举出来的主节点进行ARP报文的响应。</p>
<blockquote>
<ul>
<li>In Layer 2 mode, OpenELB uses the leader election feature of Kubernetes to ensure that only one replica responds to ARP/NDP requests.</li>
</ul>
</blockquote>
<h1 id="3、OpenELB-manager高可用"><a href="#3、OpenELB-manager高可用" class="headerlink" title="3、OpenELB-manager高可用"></a>3、OpenELB-manager高可用</h1><p>默认情况下，<code>openelb-manager</code>只会部署一个副本，对于可用性要求较高的生产环境可能无法满足需求，官方也给出了<a target="_blank" rel="noopener" href="https://openelb.github.io/docs/getting-started/configuration/configure-multiple-openelb-replicas/">部署多个副本</a>的教程。</p>
<p>官方教程的方式是推荐通过给节点添加label的方式来控制副本的部署数量和位置，这里我们将其配置为每个节点都运行一个服务（类似于daemonset）。首先我们给需要部署的节点打上labels。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 我们给集群内的三个节点都打上label</span><br>$ kubectl label --overwrite nodes tiny-calico-master-88-1.k8s.tcinternal tiny-calico-worker-88-11.k8s.tcinternal tiny-calico-worker-88-12.k8s.tcinternal lb.kubesphere.io/v1alpha1=openelb<br><br><br><span class="hljs-comment"># 查看当前节点的labels</span><br>$ kubectl get nodes -o wide --show-labels=<span class="hljs-literal">true</span> | grep openelb<br>tiny-calico-master-88-1.k8s.tcinternal    Ready    control-plane,master   16d   v1.23.6   10.31.88.1    &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.62.1.el7.x86_64   docker://20.10.14   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=tiny-calico-master-88-1.k8s.tcinternal,kubernetes.io/os=linux,lb.kubesphere.io/v1alpha1=openelb,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,node.kubernetes.io/exclude-from-external-load-balancers=<br>tiny-calico-worker-88-11.k8s.tcinternal   Ready    &lt;none&gt;                 16d   v1.23.6   10.31.88.11   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.62.1.el7.x86_64   docker://20.10.14   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=tiny-calico-worker-88-11.k8s.tcinternal,kubernetes.io/os=linux,lb.kubesphere.io/v1alpha1=openelb<br>tiny-calico-worker-88-12.k8s.tcinternal   Ready    &lt;none&gt;                 16d   v1.23.6   10.31.88.12   &lt;none&gt;        CentOS Linux 7 (Core)   3.10.0-1160.62.1.el7.x86_64   docker://20.10.14   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=tiny-calico-worker-88-12.k8s.tcinternal,kubernetes.io/os=linux,lb.kubesphere.io/v1alpha1=openelb<br></code></pre></div></td></tr></table></figure>

<p>然后我们先把副本的数量缩容到0。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl scale deployment openelb-manager --replicas=0 -n openelb-system<br></code></pre></div></td></tr></table></figure>

<p>接着修改配置，在部署节点的nodeSelector字段中增加我们前面新加的labels</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get deployment openelb-manager -n openelb-system -o yaml<br>...略去一堆输出...<br>      nodeSelector:<br>        kubernetes.io/os: linux<br>        lb.kubesphere.io/v1alpha1: openelb<br>...略去一堆输出...<br></code></pre></div></td></tr></table></figure>

<p>扩容副本数量到3。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl scale deployment openelb-manager --replicas=3 -n openelb-system<br></code></pre></div></td></tr></table></figure>

<p>检查deployment状态</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get po -n openelb-system -o wide<br>NAME                               READY   STATUS      RESTARTS   AGE   IP            NODE                                      NOMINATED NODE   READINESS GATES<br>openelb-admission-create-fvfzk     0/1     Completed   0          78m   10.88.84.89   tiny-calico-worker-88-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>openelb-admission-patch-tlmns      0/1     Completed   1          78m   10.88.84.90   tiny-calico-worker-88-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>openelb-manager-6457bdd569-6n9zr   1/1     Running     0          62m   10.31.88.1    tiny-calico-master-88-1.k8s.tcinternal    &lt;none&gt;           &lt;none&gt;<br>openelb-manager-6457bdd569-c6qfd   1/1     Running     0          62m   10.31.88.12   tiny-calico-worker-88-12.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>openelb-manager-6457bdd569-gh995   1/1     Running     0          62m   10.31.88.11   tiny-calico-worker-88-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br></code></pre></div></td></tr></table></figure>

<p>至此就完成了<code>openelb-manager</code>的高可用部署改造。</p>
<h1 id="4、BGP-Mode"><a href="#4、BGP-Mode" class="headerlink" title="4、BGP Mode"></a>4、BGP Mode</h1><table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">Hostname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.31.88.1</td>
<td align="center">tiny-calico-master-88-1.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.88.11</td>
<td align="center">tiny-calico-worker-88-11.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.88.12</td>
<td align="center">tiny-calico-worker-88-12.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.88.64.0/18</td>
<td align="center">podSubnet</td>
</tr>
<tr>
<td align="center">10.88.0.0/18</td>
<td align="center">serviceSubnet</td>
</tr>
<tr>
<td align="center">10.89.0.0/16</td>
<td align="center">OpenELB-BGP-IPpool</td>
</tr>
<tr>
<td align="center">10.31.254.251</td>
<td align="center">BGP Router</td>
</tr>
</tbody></table>
<p>这里路由器的AS号为64512，OpenELB的AS号为64154。</p>
<h2 id="4-1-创建BGP配置"><a href="#4-1-创建BGP配置" class="headerlink" title="4.1 创建BGP配置"></a>4.1 创建BGP配置</h2><p>这里我们需要创建两个CRD，分别为<a target="_blank" rel="noopener" href="https://openelb.github.io/docs/getting-started/configuration/configure-openelb-in-bgp-mode/#configure-local-bgp-properties-using-bgpconf"><code>BgpConf</code></a>和<a target="_blank" rel="noopener" href="https://openelb.github.io/docs/getting-started/configuration/configure-openelb-in-bgp-mode/#configure-peer-bgp-properties-using-bgppeer"><code>BgpPeer</code></a>，用来配置对端BGP路由器的信息和自己OpenELB的BGP配置。</p>
<ul>
<li>需要特别注意的是bgpconf这里配置的监听端口，OpenELB在默认情况下会同时监听IPv4和IPv6网络栈，因此需要确保集群开启了IPv6网络栈，否则会无法正确建立BGP连接。pod内的报错日志类似<code>&quot;listen tcp6 [::]:17900: socket: address family not supported by protocol&quot;</code></li>
<li>如果k8s集群的CNI插件使用的是类似calico的bgp模式，已经使用了服务器的179端口，那么<code>listenPort</code>就要修改为其他端口避免冲突，这里我们修改为17900避免和集群的calico使用的bird冲突</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">network.kubesphere.io/v1alpha2</span><br><br><span class="hljs-attr">kind:</span> <span class="hljs-string">BgpConf</span><br><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-comment"># BgpConf 对象的名称，无需设置，因此openelb只认default，设置成别的会被忽略</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">default</span><br><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-comment"># openelb 的ASN，必须与BgpPeer配置中的spec:conf:peerAS值不同。</span><br>  <span class="hljs-attr">as:</span> <span class="hljs-number">64514</span><br><br>  <span class="hljs-comment"># OpenELB 监听的端口。默认值为179（默认 BGP 端口号）。</span><br>  <span class="hljs-comment"># 如果 Kubernetes 集群中的其他组件（例如 Calico）也使用 BGP 和 179 端口，则必须设置不同的值以避免冲突。</span><br>  <span class="hljs-attr">listenPort:</span> <span class="hljs-number">17900</span><br><br>  <span class="hljs-comment"># 本地路由器ID，通常设置为Kubernetes主节点的主网卡IP地址。</span><br>  <span class="hljs-comment"># 如果不指定该字段，则使用openelb-manager所在节点的第一个IP地址。</span><br>  <span class="hljs-attr">routerId:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.88</span><span class="hljs-number">.1</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">network.kubesphere.io/v1alpha2</span><br><br><span class="hljs-attr">kind:</span> <span class="hljs-string">BgpPeer</span><br><br><span class="hljs-attr">metadata:</span><br><br>  <span class="hljs-comment"># BgpPeer 对象的名称</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">bgppeer-openwrt-plus</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">conf:</span><br>    <span class="hljs-comment"># 对端BGP路由器的ASN，必须与BgpConf配置中的spec:as值不同。</span><br>    <span class="hljs-attr">peerAs:</span> <span class="hljs-number">64512</span><br>    <span class="hljs-comment"># 对端BGP路由器的IP</span><br>    <span class="hljs-attr">neighborAddress:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.254</span><span class="hljs-number">.251</span><br><br>  <span class="hljs-comment"># 指定IP协议栈（IPv4/IPv6）。</span><br>  <span class="hljs-comment"># 不用修改，因此目前，OpenELB 仅支持 IPv4。</span><br>  <span class="hljs-attr">afiSafis:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">config:</span><br>        <span class="hljs-attr">family:</span><br>          <span class="hljs-attr">afi:</span> <span class="hljs-string">AFI_IP</span><br>          <span class="hljs-attr">safi:</span> <span class="hljs-string">SAFI_UNICAST</span><br>        <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">addPaths:</span><br>        <span class="hljs-attr">config:</span><br>          <span class="hljs-comment"># OpenELB 可以发送到对等 BGP 路由器以进行等价多路径 (ECMP) 路由的最大等效路由数。</span><br>          <span class="hljs-attr">sendMax:</span> <span class="hljs-number">10</span><br>  <span class="hljs-attr">nodeSelector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-comment"># 如果 Kubernetes 集群节点部署在不同的路由器下，并且每个节点都有一个 OpenELB 副本，则需要配置此字段，以便正确节点上的 OpenELB 副本与对端 BGP 路由器建立 BGP 连接。</span><br>      <span class="hljs-comment"># 默认情况下，所有 openelb-manager 副本都会响应 BgpPeer 配置并尝试与对等 BGP 路由器建立 BGP 连接。</span><br>      <span class="hljs-attr">openelb.kubesphere.io/rack:</span> <span class="hljs-string">leaf1</span><br></code></pre></div></td></tr></table></figure>

<p>然后我们部署并查看信息</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f openelb/openelb-bgp.yaml<br>bgpconf.network.kubesphere.io/default created<br>bgppeer.network.kubesphere.io/bgppeer-openwrt-plus created<br>$ kubectl get bgpconf<br>NAME      AGE<br>default   16s<br>$ kubectl get bgppeer<br>NAME                   AGE<br>bgppeer-openwrt-plus   20s<br></code></pre></div></td></tr></table></figure>



<h2 id="4-2-修改EIP"><a href="#4-2-修改EIP" class="headerlink" title="4.2 修改EIP"></a>4.2 修改EIP</h2><p>和之前的Layer2模式类似，我们也需要创建一个BGP模式使用的Eip。</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">network.kubesphere.io/v1alpha2</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Eip</span><br><span class="hljs-attr">metadata:</span><br>    <span class="hljs-comment"># Eip 对象的名称。</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">eip-bgp-pool</span><br><span class="hljs-attr">spec:</span><br>    <span class="hljs-comment"># Eip 对象的地址池</span><br>    <span class="hljs-attr">address:</span> <span class="hljs-number">10.89</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><span class="hljs-number">-10.89</span><span class="hljs-number">.255</span><span class="hljs-number">.254</span><br><br>    <span class="hljs-comment"># openELB的运行模式，默认为bgp</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">bgp</span><br><br>    <span class="hljs-comment"># OpenELB 在其上侦听 ARP/NDP 请求的网卡。该字段仅在protocol设置为时有效layer2。</span><br>    <span class="hljs-attr">interface:</span> <span class="hljs-string">eth0</span><br><br>    <span class="hljs-comment"># 指定是否禁用 Eip 对象</span><br>    <span class="hljs-comment"># false表示可以继续分配</span><br>    <span class="hljs-comment"># true表示不再继续分配</span><br>    <span class="hljs-attr">disable:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">status:</span><br><br>    <span class="hljs-comment"># 指定 Eip 对象中的IP地址是否已用完。</span><br>    <span class="hljs-attr">occupied:</span> <span class="hljs-literal">false</span><br><br>    <span class="hljs-comment"># 指定 Eip 对象中有多少个 IP 地址已分配给服务。</span><br>    <span class="hljs-comment"># 直接留空，系统会自动生成</span><br>    <span class="hljs-attr">usage:</span> <br><br>    <span class="hljs-comment"># Eip 对象中的 IP 地址总数。</span><br>    <span class="hljs-attr">poolSize:</span> <span class="hljs-number">65534</span><br><br>    <span class="hljs-comment"># 指定使用的 IP 地址和使用 IP 地址的服务。服务以Namespace/Service name格式显示（例如，default/test-svc）。</span><br>    <span class="hljs-comment"># 直接留空，系统会自动生成</span><br>    <span class="hljs-attr">used:</span> <br><br>    <span class="hljs-comment"># Eip 对象中的第一个 IP 地址。</span><br>    <span class="hljs-attr">firstIP:</span> <span class="hljs-number">10.89</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span><br>    <span class="hljs-comment"># Eip 对象中的最后一个 IP 地址。</span><br>    <span class="hljs-attr">lastIP:</span> <span class="hljs-number">10.89</span><span class="hljs-number">.255</span><span class="hljs-number">.254</span><br><br>    <span class="hljs-attr">ready:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-comment"># 指定IP协议栈是否为 IPv4。目前，OpenELB 仅支持 IPv4，其值只能是true.</span><br>    <span class="hljs-attr">v4:</span> <span class="hljs-literal">true</span><br></code></pre></div></td></tr></table></figure>

<p>然后我们部署并查看信息，可以看到两个eip资源都存在系统中。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f openelb/openelb-eip-bgp.yaml<br>eip.network.kubesphere.io/eip-bgp-pool created<br>[root@tiny-calico-master-88-1 tiny-calico]<span class="hljs-comment"># kubectl get eip</span><br>NAME              CIDR                        USAGE   TOTAL<br>eip-bgp-pool      10.89.0.1-10.89.255.254             65534<br>eip-layer2-pool   10.31.88.101-10.31.88.200   3       100<br></code></pre></div></td></tr></table></figure>

<h2 id="4-3-配置路由器"><a href="#4-3-配置路由器" class="headerlink" title="4.3 配置路由器"></a>4.3 配置路由器</h2><p>以家里常见的openwrt路由器为例，我们先在上面安装quagga组件，当然要是使用的openwrt版本<a target="_blank" rel="noopener" href="http://docs.frrouting.org/projects/dev-guide/en/latest/building-frr-for-openwrt.html">编译了frr模块</a>的话<strong>推荐使用frr</strong>来进行配置。</p>
<blockquote>
<p>如果使用的是别的发行版Linux（如CentOS或者Debian）推荐直接使用<a target="_blank" rel="noopener" href="https://frrouting.org/"><code>frr</code></a>进行配置。</p>
</blockquote>
<p>我们先在openwrt上面直接使用opkg安装quagga</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ opkg update <br>$ opkg install quagga quagga-zebra quagga-bgpd quagga-vtysh<br></code></pre></div></td></tr></table></figure>

<p>如果使用的openwrt版本足够新，是可以直接使用opkg安装frr组件的</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ opkg update <br>$ opkg install frr frr-babeld frr-bfdd frr-bgpd frr-eigrpd frr-fabricd frr-isisd frr-ldpd frr-libfrr frr-nhrpd frr-ospf6d frr-ospfd frr-pbrd frr-pimd frr-ripd frr-ripngd frr-staticd frr-vrrpd frr-vtysh frr-watchfrr frr-zebra<br></code></pre></div></td></tr></table></figure>

<p>如果是使用frr记得在配置中开启bgpd参数再重启frr</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ sed -i <span class="hljs-string">&#x27;s/bgpd=no/bgpd=yes/g&#x27;</span> /etc/frr/daemons<br>$ /etc/init.d/frr restart<br></code></pre></div></td></tr></table></figure>

<p>路由器这边我们使用frr进行BGP协议的配置，需要注意的是因为前面我们把端口修改为17900，因此这里也需要进行同步配置节点端口为17900。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">root@tiny-openwrt-plus:~<span class="hljs-comment"># cat /etc/frr/frr.conf</span><br>frr version 8.2.2<br>frr defaults traditional<br>hostname tiny-openwrt-plus<br><span class="hljs-built_in">log</span> file /home/frr/frr.log<br><span class="hljs-built_in">log</span> syslog<br>!<br>password zebra<br>!<br>router bgp 64512<br> bgp router-id 10.31.254.251<br> no bgp ebgp-requires-policy<br> !<br> !<br> neighbor 10.31.88.1 remote-as 64514<br> neighbor 10.31.88.1 port 17900<br> neighbor 10.31.88.1 description 10-31-88-1<br><br> neighbor 10.31.88.11 remote-as 64514<br> neighbor 10.31.88.11 port 17900<br> neighbor 10.31.88.11 description 10-31-88-11<br><br> neighbor 10.31.88.12 remote-as 64514<br> neighbor 10.31.88.12 port 17900<br> neighbor 10.31.88.12 description 10-31-88-12<br> !<br> !<br> address-family ipv4 unicast<br> !maximum-paths 3<br> exit-address-family<br><span class="hljs-built_in">exit</span><br>!<br>access-list vty seq 5 permit 127.0.0.0/8<br>access-list vty seq 10 deny any<br>!<br>line vty<br> access-class vty<br><span class="hljs-built_in">exit</span><br>!<br></code></pre></div></td></tr></table></figure>



<h2 id="4-4-部署测试服务"><a href="#4-4-部署测试服务" class="headerlink" title="4.4 部署测试服务"></a>4.4 部署测试服务</h2><p>这里我们创建两个服务进行测试，需要注意和上面的layer2模式不同，这里的注解要同步修改为使用bgp和对应的eip。</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb2-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">lb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">openelb</span><br>    <span class="hljs-attr">protocol.openelb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">bgp</span><br>    <span class="hljs-attr">eip.openelb.kubesphere.io/v1alpha2:</span> <span class="hljs-string">eip-bgp-pool</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <br><span class="hljs-meta">---</span><br><span class="hljs-meta"></span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb3-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">lb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">openelb</span><br>    <span class="hljs-attr">protocol.openelb.kubesphere.io/v1alpha1:</span> <span class="hljs-string">bgp</span><br>    <span class="hljs-attr">eip.openelb.kubesphere.io/v1alpha2:</span> <span class="hljs-string">eip-bgp-pool</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">loadBalancerIP:</span> <span class="hljs-number">10.89</span><span class="hljs-number">.100</span><span class="hljs-number">.100</span><br></code></pre></div></td></tr></table></figure>

<p>部署完成之后我们再查看服务的状态，可以看到没有指定<code>loadBalancerIP</code>的服务会自动按顺序分配一个可用IP，而指定了IP的会分配为我们手动指定的IP，同时layer2模式的也可以共存。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get eip -A<br>NAME              CIDR                        USAGE   TOTAL<br>eip-bgp-pool      10.89.0.1-10.89.255.254     2       65534<br>eip-layer2-pool   10.31.88.101-10.31.88.200   1       100<br>$ kubectl get svc -n nginx-quic<br>NAME                TYPE           CLUSTER-IP     EXTERNAL-IP     PORT(S)        AGE<br>nginx-lb-service    LoadBalancer   10.88.15.40    10.31.88.101    80:30972/TCP   2m48s<br>nginx-lb2-service   LoadBalancer   10.88.60.227   10.89.0.1       80:30425/TCP   2m48s<br>nginx-lb3-service   LoadBalancer   10.88.11.160   10.89.100.100   80:30597/TCP   2m48s<br></code></pre></div></td></tr></table></figure>

<p>再查看路由器上面的路由表，可以看到两个BGP模式的VIP有多个下一条路由，则说明ECMP开启成功</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tiny-openwrt-plus<span class="hljs-comment"># show ip route</span><br>Codes: K - kernel route, C - connected, S - static, R - RIP,<br>       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,<br>       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,<br>       f - OpenFabric,<br>       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup<br>       t - trapped, o - offload failure<br><br>K&gt;* 0.0.0.0/0 [0/0] via 10.31.254.254, eth0, 12:56:32<br>C&gt;* 10.31.0.0/16 is directly connected, eth0, 12:56:32<br>B&gt;* 10.89.0.1/32 [20/0] via 10.31.88.1, eth0, weight 1, 00:00:28<br>  *                     via 10.31.88.11, eth0, weight 1, 00:00:28<br>  *                     via 10.31.88.12, eth0, weight 1, 00:00:28<br>B&gt;* 10.89.100.100/32 [20/0] via 10.31.88.1, eth0, weight 1, 00:00:28<br>  *                         via 10.31.88.11, eth0, weight 1, 00:00:28<br>  *                         via 10.31.88.12, eth0, weight 1, 00:00:28<br></code></pre></div></td></tr></table></figure>

<p>最后再找一台机器进行curl测试</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">[tinychen /root]<span class="hljs-comment"># curl 10.89.0.1</span><br>10.31.88.1:22432<br>[tinychen /root]<span class="hljs-comment"># curl 10.89.100.100</span><br>10.31.88.11:59470<br></code></pre></div></td></tr></table></figure>

<h1 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h1><p>OpenELB的两种模式的优缺点和<a href="https://tinychen.com/20220519-k8s-06-loadbalancer-metallb/">MetalLB</a>几乎一模一样，两者在这方面的优缺点概况文档可以结合起来一起看：</p>
<h2 id="5-1-Layer2-mode优缺点"><a href="#5-1-Layer2-mode优缺点" class="headerlink" title="5.1 Layer2 mode优缺点"></a>5.1 Layer2 mode优缺点</h2><p><strong>优点：</strong></p>
<ul>
<li>通用性强，对比BGP模式不需要BGP路由器支持，几乎可以适用于任何网络环境；当然云厂商的网络环境例外</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>所有的流量都会在同一个节点上，该节点的容易成为流量的瓶颈</li>
<li>当VIP所在节点宕机之后，需要较长时间进行故障转移（官方没说多久），这主要是因为OpenELB使用了k8s同款的选主算法来进行选主，当VIP所在节点宕机之后重新选主的时间要比传统的keepalived使用的vrrp协议（一般为1s）要更长</li>
<li>难以定位VIP所在节点，OpenELB并没有提供一个简单直观的方式让我们查看到底哪一个节点是VIP所属节点，基本只能通过抓包或者查看pod日志来确定，当集群规模变大的时候这会变得非常的麻烦</li>
</ul>
<p><strong>改进方案：</strong></p>
<ul>
<li>有条件的可以考虑使用BGP模式</li>
<li>既不能用BGP模式也不能接受Layer2模式的，基本和目前主流的三个开源负载均衡器无缘了（三者都是Layer2模式和BGP模式且原理类似，优缺点相同）</li>
</ul>
<h2 id="5-2-BGP-mode优缺点"><a href="#5-2-BGP-mode优缺点" class="headerlink" title="5.2 BGP mode优缺点"></a>5.2 BGP mode优缺点</h2><p>BGP模式的优缺点几乎和Layer2模式相反</p>
<p><strong>优点：</strong></p>
<ul>
<li>无单点故障，在开启ECMP的前提下，k8s集群内所有的节点都有请求流量，都会参与负载均衡并转发请求</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>条件苛刻，需要有BGP路由器支持，配置起来也更复杂；</li>
<li>ECMP的故障转移（failover）并不是特别地优雅，这个问题的严重程度取决于使用的ECMP算法；当集群的节点出现变动导致BGP连接出现变动，所有的连接都会进行重新哈希（使用三元组或五元组哈希），这对一些服务来说可能会有影响；</li>
</ul>
<blockquote>
<p>路由器中使用的哈希值通常 <em>不稳定</em>，因此每当后端集的大小发生变化时（例如，当一个节点的 BGP 会话关闭时），现有的连接将被有效地随机重新哈希，这意味着大多数现有的连接最终会突然被转发到不同的后端，而这个后端可能和此前的后端毫不相干且不清楚上下文状态信息。</p>
</blockquote>
<p><strong>改进方案：</strong></p>
<p>OpenELB官方并没有给出BGP模式的优缺点分析和改进方案，但是我们可以参考MetalLB官方给出的资料：</p>
<p>MetalLB给出了一些<a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/bgp/#limitations">改进方案</a>，下面列出来给大家参考一下</p>
<ul>
<li>使用更稳定的ECMP算法来减少后端变动时对现有连接的影响，如“resilient ECMP” or “resilient LAG”</li>
<li>将服务部署到特定的节点上减少可能带来的影响</li>
<li>在流量低峰期进行变更</li>
<li>将服务分开部署到两个不同的LoadBalanceIP的服务中，然后利用DNS进行流量切换</li>
<li>在客户端加入透明的用户无感的重试逻辑</li>
<li>在LoadBalance后面加入一层ingress来实现更优雅的failover（但是并不是所有的服务都可以使用ingress）</li>
<li>接受现实……（Accept that there will be occasional bursts of reset connections. For low-availability internal services, this may be acceptable as-is.）</li>
</ul>
<h2 id="5-3-OpenELB优缺点"><a href="#5-3-OpenELB优缺点" class="headerlink" title="5.3 OpenELB优缺点"></a>5.3 OpenELB优缺点</h2><p>这里尽量客观的总结概况一些客观事实，是否为优缺点可能会因人而异：</p>
<ul>
<li>OpenELB是国内的青云科技团队主导开发的产品（也是kubesphere的开发团队）</li>
<li>OpenELB的部署方式并不是使用<code>daemonset</code>+<code>deployment</code>的方式，而是使用<code>deployment</code>+<code>jobs.batch</code>，</li>
<li>OpenELB的<code>deployment</code>默认状态下并没有高可用部署，需要自己手动配置</li>
<li>OpenELB的文档非常少，比MetalLB的还要少，仅有少数几篇必要的文档，<strong>建议先全部阅读完再开始上手</strong></li>
<li>OpenELB对IPv6的支持不完善（<strong>BGP模式下暂不支持IPv6</strong>）</li>
<li>OpenELB可以通过注解来<strong>同时部署使用</strong>BGP模式和Layer2模式</li>
<li>OpenELB使用了CRD来一定程度上改善了IPAM的问题，<strong>可以通过查看EIP的状态来查看IP池的分配情况和对应服务</strong></li>
<li>OpenELB在Layer2模式下<strong>无法快速定位当前的VIP所在节点</strong></li>
<li>OpenELB官方表示已经有一定的数量的<a target="_blank" rel="noopener" href="https://github.com/openelb/openelb/blob/master/ADOPTERS.md">企业</a>采用（包括生产和测试环境），但是没有具体披露使用的模式和规模</li>
</ul>
<p>总的来说，OpenELB是一款不错的负载均衡器，在前人MetalLB的基础上做了一些改进，有一定的社区热度、有一定的专业团队进行维护；但是目前感觉还处于比较初级的阶段，有较多的功能还没有开发完善，使用起来偶尔会有些不大不小的问题。青云科技官方表示会在后面的kubesphere v3.3.0版本内置OpenELB用于服务暴露，届时应该会有更多的用户参与进来。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/cloudnative/">cloudnative</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/k8s/">k8s</a>
                    
                      <a class="hover-with-bg" href="/tags/loadbalance/">loadbalance</a>
                    
                      <a class="hover-with-bg" href="/tags/metallb/">metallb</a>
                    
                      <a class="hover-with-bg" href="/tags/openelb/">openelb</a>
                    
                      <a class="hover-with-bg" href="/tags/purelb/">purelb</a>
                    
                      <a class="hover-with-bg" href="/tags/bgp/">bgp</a>
                    
                      <a class="hover-with-bg" href="/tags/quagga/">quagga</a>
                    
                      <a class="hover-with-bg" href="/tags/frr/">frr</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/20220524-k8s-08-loadbalancer-purelb/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">k8s系列08-负载均衡器之PureLB</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20220519-k8s-06-loadbalancer-metallb/">
                        <span class="hidden-mobile">k8s系列06-负载均衡器之MatelLB</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>since 2017 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备18140640号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-166769908-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>

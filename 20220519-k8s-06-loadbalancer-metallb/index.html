

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="https://resource.tinychen.com/logos.png">
  <link rel="icon" href="https://resource.tinychen.com/logos.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
    <meta http-equiv="Content-Security-Policy" content="upgrade-insecure-requests">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="TinyChen">
  <meta name="keywords" content="">
  
    <meta name="description" content="本文主要在k8s原生集群上部署v0.12.1版本的MetalLB作为k8s的LoadBalancer，主要涉及MetalLB的Layer2模式和BGP模式两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。 文中使用的k8s集群是在CentOS7系统上基于docker和flannel组件部署v1.23.6版本，此前写的一些关于k8s基础知识和集群搭建的一些方案，有需要的同">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s系列06-负载均衡器之MatelLB">
<meta property="og:url" content="https://tinychen.com/20220519-k8s-06-loadbalancer-metallb/index.html">
<meta property="og:site_name" content="TinyChen&#39;s Studio - 互联网技术学习工作经验分享">
<meta property="og:description" content="本文主要在k8s原生集群上部署v0.12.1版本的MetalLB作为k8s的LoadBalancer，主要涉及MetalLB的Layer2模式和BGP模式两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。 文中使用的k8s集群是在CentOS7系统上基于docker和flannel组件部署v1.23.6版本，此前写的一些关于k8s基础知识和集群搭建的一些方案，有需要的同">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://resource.tinychen.com/202205191208121.jpg">
<meta property="article:published_time" content="2022-05-19T04:00:00.000Z">
<meta property="article:modified_time" content="2022-05-19T04:00:00.000Z">
<meta property="article:author" content="TinyChen">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="loadbalance">
<meta property="article:tag" content="metallb">
<meta property="article:tag" content="openelb">
<meta property="article:tag" content="purelb">
<meta property="article:tag" content="bgp">
<meta property="article:tag" content="quagga">
<meta property="article:tag" content="frr">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://resource.tinychen.com/202205191208121.jpg">
  
  
  <title>k8s系列06-负载均衡器之MatelLB - TinyChen&#39;s Studio - 互联网技术学习工作经验分享</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css" />


  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4/github-markdown.min.css" />
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hint.css@2/hint.min.css" />

  
    
    
      
      <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10/styles/dracula.min.css" />
    
  

  
    <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.css" />
  


<!-- 主题依赖的图标库，不要自行修改 -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />

<!-- 自定义样式保持在最底部 -->

  
<link rel="stylesheet" href="/css/fluid-extention.css">



  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"tinychen.com","root":"/","version":"1.8.14","typing":{"enable":true,"typeSpeed":30,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"baidu":"7a96963a1145ac7fde1442d739a11ffd","google":"UA-166769908-1","gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="TinyChen's Studio - 互联网技术学习工作经验分享" type="application/atom+xml">
</head>


<body>
  <header style="height: 70vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>TinyChen</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                Home
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                Archives
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                Categories
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                Tags
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                About
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('https://resource.tinychen.com/202205191207289.jpg') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="k8s系列06-负载均衡器之MatelLB">
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-05-19 12:00" pubdate>
        May 19, 2022 pm
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      35k 字
    </span>
  

  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">k8s系列06-负载均衡器之MatelLB</h1>
            
              <p class="note note-info">
                
                  本文最后更新于：May 19, 2022 pm
                
              </p>
            
            <div class="markdown-body">
              <p>本文主要在k8s原生集群上部署<code>v0.12.1</code>版本的<code>MetalLB</code>作为k8s的<code>LoadBalancer</code>，主要涉及<strong>MetalLB</strong>的<strong>Layer2模式</strong>和<strong>BGP模式</strong>两种部署方案。由于BGP的相关原理和配置比较复杂，这里仅涉及简单的BGP配置。</p>
<p>文中使用的k8s集群是在CentOS7系统上基于<code>docker</code>和<code>flannel</code>组件部署<code>v1.23.6</code>版本，此前写的一些关于k8s基础知识和集群搭建的一些<a href="https://tinychen.com/tags/k8s/">方案</a>，有需要的同学可以看一下。</p>
<span id="more"></span>

<h1 id="1、工作原理"><a href="#1、工作原理" class="headerlink" title="1、工作原理"></a>1、工作原理</h1><h2 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h2><p>在开始之前，我们需要了解一下MetalLB的工作原理。</p>
<blockquote>
<p>MetalLB hooks into your Kubernetes cluster, and provides a network load-balancer implementation. In short, it allows you to create Kubernetes services of type <code>LoadBalancer</code> in clusters that don’t run on a cloud provider, and thus cannot simply hook into paid products to provide load balancers.</p>
<p>It has two features that work together to provide this service: address allocation, and external announcement.</p>
</blockquote>
<p>MetalLB是 Kubernetes 集群中关于LoadBalancer的一个具体实现，主要用于暴露k8s集群的服务到集群外部访问。MetalLB可以让我们在k8s集群中创建服务类型为<code>LoadBalancer</code>的服务，并且无需依赖云厂商提供的<code>LoadBalancer</code>。</p>
<p>它具有两个共同提供此服务的工作负载（workload）：地址分配（address allocation）和外部公告（external announcement）；对应的就是在k8s中部署的<code>controller</code>和<code>speaker</code>。</p>
<h2 id="1-2-address-allocation"><a href="#1-2-address-allocation" class="headerlink" title="1.2 address allocation"></a>1.2 address allocation</h2><p>地址分配（address allocation）这个功能比较好理解，首先我们需要给MetalLB分配一段IP，接着它会根据k8s的service中的相关配置来给<code>LoadBalancer</code>的服务分配IP，从官网文档中我们可以得知<code>LoadBalancer</code>的IP可以手动指定，也可以让MetalLB自动分配；同时还可以在MetalLB的<code>configmap</code>中配置多个IP段，并且单独设置每个IP段是否开启自动分配。</p>
<p>地址分配（address allocation）主要就是由作为<code>deployment</code>部署的<code>controller</code>来实现，它负责监听集群中的service状态并且分配IP</p>
<h2 id="1-3-external-announcement"><a href="#1-3-external-announcement" class="headerlink" title="1.3 external announcement"></a>1.3 external announcement</h2><p>外部公告（external announcement）的主要功能就是要把服务类型为<code>LoadBalancer</code>的服务的<code>EXTERNAL-IP</code>公布到网络中去，确保客户端能够正常访问到这个IP。MetalLB对此的实现方式主要有三种：ARP&#x2F;NDP和BGP；其中ARP&#x2F;NDP分别对应IPv4&#x2F;IPv6协议的Layer2模式，BGP路由协议则是对应BGP模式。外部公告（external announcement）主要就是由作为<code>daemonset</code>部署的<code>speaker</code>来实现，它负责在网络中发布ARP&#x2F;NDP报文或者是和BGP路由器建立连接并发布BGP报文。</p>
<h2 id="1-4-关于网络"><a href="#1-4-关于网络" class="headerlink" title="1.4 关于网络"></a>1.4 关于网络</h2><p>不管是Layer2模式还是BGP模式，两者都不使用Linux的网络栈，也就是说我们没办法使用诸如<code>ip</code>命令之类的操作准确的查看VIP所在的节点和相应的路由，相对应的是在每个节点上面都能看到一个<code>kube-ipvs0</code>网卡接口上面的IP。同时，两种模式都只是负责把VIP的请求引到对应的节点上面，之后的请求怎么到达pod，按什么规则轮询等都是由kube-proxy实现的。</p>
<p>两种不同的模式各有优缺点和局限性，我们先把两者都部署起来再进行分析。</p>
<h1 id="2、准备工作"><a href="#2、准备工作" class="headerlink" title="2、准备工作"></a>2、准备工作</h1><h2 id="2-1-系统要求"><a href="#2-1-系统要求" class="headerlink" title="2.1 系统要求"></a>2.1 系统要求</h2><p>在开始部署MetalLB之前，我们需要确定部署环境能够满足最低要求：</p>
<ul>
<li>一个k8s集群，要求版本不低于1.13.0，且没有负载均衡器相关插件</li>
<li>k8s集群上的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/network-addons/">CNI组件</a>和MetalLB兼容</li>
<li>预留一段IPv4地址给MetalLB作为LoadBalance的VIP使用</li>
<li>如果使用的是MetalLB的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/bgp/">BGP模式</a>，还需要路由器支持<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol">BGP协议</a></li>
<li>如果使用的是MetalLB的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/layer2/">Layer2模式</a>，因为使用了<a target="_blank" rel="noopener" href="https://github.com/hashicorp/memberlist">memberlist</a>算法来实现选主，因此需要确保各个k8s节点之间的7946端口可达（包括TCP和UDP协议），当然也可以根据自己的需求配置为其他端口</li>
</ul>
<h2 id="2-2-cni插件的兼容性"><a href="#2-2-cni插件的兼容性" class="headerlink" title="2.2 cni插件的兼容性"></a>2.2 cni插件的兼容性</h2><p>MetalLB官方给出了对主流的一些CNI的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/network-addons/">兼容情况</a>，考虑到MetalLB主要还是利用了k8s自带的kube-proxy组件做流量转发，因此对大多数的CNI兼容情况都相当不错。</p>
<table>
<thead>
<tr>
<th align="center">CNI</th>
<th align="center">兼容性</th>
<th align="center">主要问题</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Calico</td>
<td align="center">Mostly (see <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/calico/">known issues</a>)</td>
<td align="center">主要在于BGP模式的兼容性，但是社区也提供了<a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/calico/">解决方案</a></td>
</tr>
<tr>
<td align="center">Canal</td>
<td align="center">Yes</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">Cilium</td>
<td align="center">Yes</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">Flannel</td>
<td align="center">Yes</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">Kube-ovn</td>
<td align="center">Yes</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">Kube-router</td>
<td align="center">Mostly (see <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/kube-router/">known issues</a>)</td>
<td align="center">无法支持 <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/kube-router/">builtin external BGP peering mode</a></td>
</tr>
<tr>
<td align="center">Weave Net</td>
<td align="center">Mostly (see <a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/weave/">known issues</a>)</td>
<td align="center"><code>externalTrafficPolicy: Local</code>支持情况视<a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/weave/">版本而定</a></td>
</tr>
</tbody></table>
<p>从兼容性上面我们不难看出，大多数情况是没问题的，出现兼容性问题的主要原因就是和BGP有冲突。实际上BGP相关的兼容性问题几乎存在于每个开源的k8s负载均衡器上面。</p>
<h2 id="2-3-云厂商的兼容性"><a href="#2-3-云厂商的兼容性" class="headerlink" title="2.3 云厂商的兼容性"></a>2.3 云厂商的兼容性</h2><p>MetalLB官方给出的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/clouds/">列表</a>中，我们可以看到对大多数云厂商的兼容性都很差，原因也很简单，大多数的云环境上面都没办法运行BGP协议，而通用性更高的layer2模式则因为各个云厂商的网络环境不同而没办法确定是否能够兼容</p>
<blockquote>
<p>The short version is: cloud providers expose proprietary APIs instead of standard protocols to control their network layer, and MetalLB doesn’t work with those APIs.</p>
</blockquote>
<p>当然如果使用了云厂商的服务，最好的方案是直接使用云厂商提供的<code>LoadBalance</code>服务。</p>
<h1 id="3、Layer2-mode"><a href="#3、Layer2-mode" class="headerlink" title="3、Layer2 mode"></a>3、Layer2 mode</h1><h2 id="3-1-部署环境"><a href="#3-1-部署环境" class="headerlink" title="3.1 部署环境"></a>3.1 部署环境</h2><p>本次<code>MetalLB</code>的部署环境为基于<code>docker</code>和<code>flannel</code>部署的<code>1.23.6</code>版本的k8s集群</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">Hostname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.31.8.1</td>
<td align="center">tiny-flannel-master-8-1.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.8.11</td>
<td align="center">tiny-flannel-worker-8-11.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.8.12</td>
<td align="center">tiny-flannel-worker-8-12.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.8.64.0&#x2F;18</td>
<td align="center">podSubnet</td>
</tr>
<tr>
<td align="center">10.8.0.0&#x2F;18</td>
<td align="center">serviceSubnet</td>
</tr>
<tr>
<td align="center">10.31.8.100-10.31.8.200</td>
<td align="center">MetalLB IPpool</td>
</tr>
</tbody></table>
<h2 id="3-2-配置ARP参数"><a href="#3-2-配置ARP参数" class="headerlink" title="3.2 配置ARP参数"></a>3.2 配置ARP参数</h2><p>部署Layer2模式需要把k8s集群中的ipvs配置打开<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/config-api/kube-proxy-config.v1alpha1/"><code>strictARP</code></a>，开启之后k8s集群中的<code>kube-proxy</code>会停止响应<code>kube-ipvs0</code>网卡之外的其他网卡的arp请求，而由MetalLB接手处理。</p>
<p><code>strict ARP</code>开启之后相当于把 将 <code>arp_ignore</code> 设置为 1 并将 <code>arp_announce</code> 设置为 2 启用严格的 ARP，这个原理和LVS中的DR模式对RS的配置一样，可以参考之前的<a href="https://tinychen.com/20200427-lvs-principle-introduction/#6%E3%80%81ARP-in-LVS">文章中的解释</a>。</p>
<blockquote>
<p>strict ARP configure arp_ignore and arp_announce to avoid answering ARP queries from kube-ipvs0 interface</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 查看kube-proxy中的strictARP配置</span><br>$ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP<br>      strictARP: <span class="hljs-literal">false</span><br><br><span class="hljs-comment"># 手动修改strictARP配置为true</span><br>$ kubectl edit configmap -n kube-system kube-proxy<br>configmap/kube-proxy edited<br><br><span class="hljs-comment"># 使用命令直接修改并对比不同</span><br>$ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e <span class="hljs-string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | kubectl diff -f - -n kube-system<br><br><span class="hljs-comment"># 确认无误后使用命令直接修改并生效</span><br>$ kubectl get configmap kube-proxy -n kube-system -o yaml | sed -e <span class="hljs-string">&quot;s/strictARP: false/strictARP: true/&quot;</span> | kubectl apply -f - -n kube-system<br><br><span class="hljs-comment"># 重启kube-proxy确保配置生效</span><br>$ kubectl rollout restart ds kube-proxy -n kube-system<br><br><span class="hljs-comment"># 确认配置生效</span><br>$ kubectl get configmap -n kube-system kube-proxy -o yaml | grep strictARP<br>      strictARP: <span class="hljs-literal">true</span><br><br></code></pre></div></td></tr></table></figure>



<h2 id="3-3-部署MetalLB"><a href="#3-3-部署MetalLB" class="headerlink" title="3.3 部署MetalLB"></a>3.3 部署MetalLB</h2><p>MetalLB的部署也十分简单，官方提供了<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/#installation-by-manifest">manifest文件部署</a>（yaml部署），<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/#installation-with-helm">helm3部署</a>和<a target="_blank" rel="noopener" href="https://metallb.universe.tf/installation/#installation-with-kustomize">Kustomize部署</a>三种方式，这里我们还是使用manifest文件部署。</p>
<p>大多数的官方教程为了简化部署的步骤，都是写着直接用kubectl命令部署一个yaml的url，这样子的好处是部署简单快捷，但是坏处就是本地自己没有存档，不方便修改等操作，因此我个人更倾向于把yaml文件下载到本地保存再进行部署。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 下载v0.12.1的两个部署文件</span><br>$ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml<br>$ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb.yaml<br><br><span class="hljs-comment"># 如果使用frr来进行BGP路由管理，则下载这两个部署文件</span><br>$ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/namespace.yaml<br>$ wget https://raw.githubusercontent.com/metallb/metallb/v0.12.1/manifests/metallb-frr.yaml<br></code></pre></div></td></tr></table></figure>

<p>下载官方提供的yaml文件之后，我们再提前准备好<code>configmap</code>的<a target="_blank" rel="noopener" href="https://metallb.universe.tf/configuration/">配置</a>，github上面有提供一个<a target="_blank" rel="noopener" href="https://github.com/metallb/metallb/blob/main/config/samples/example-config.yaml">参考文件</a>，layer2模式需要的配置并不多，这里我们只做最基础的一些参数配置定义即可：</p>
<ul>
<li><code>protocol</code>这一项我们配置为<code>layer2</code></li>
<li><code>addresses</code>这里我们可以使用CIDR来批量配置（<code>198.51.100.0/24</code>），也可以指定首尾IP来配置（<code>192.168.0.150-192.168.0.200</code>），这里我们指定一段和k8s节点在同一个子网的IP</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-string">$</span> <span class="hljs-string">cat</span> <span class="hljs-string">&gt;</span> <span class="hljs-string">configmap-metallb.yaml</span> <span class="hljs-string">&lt;&lt;EOF</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">metallb-system</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    address-pools:</span><br><span class="hljs-string">    - name: default</span><br><span class="hljs-string">      protocol: layer2</span><br><span class="hljs-string">      addresses:</span><br><span class="hljs-string">      - 10.31.8.100-10.31.8.200</span><br><span class="hljs-string"></span><span class="hljs-string">EOF</span><br></code></pre></div></td></tr></table></figure>

<p>接下来就可以开始进行部署，整体可以分为三步：</p>
<ol>
<li>部署<code>namespace</code></li>
<li>部署<code>deployment</code>和<code>daemonset</code></li>
<li>配置<code>configmap</code></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 创建namespace</span><br>$ kubectl apply -f namespace.yaml<br>namespace/metallb-system created<br>$ kubectl get ns<br>NAME              STATUS   AGE<br>default           Active   8d<br>kube-node-lease   Active   8d<br>kube-public       Active   8d<br>kube-system       Active   8d<br>metallb-system    Active   8s<br>nginx-quic        Active   8d<br><br><span class="hljs-comment"># 部署deployment和daemonset，以及相关所需的其他资源</span><br>$ kubectl apply -f metallb.yaml<br>Warning: policy/v1beta1 PodSecurityPolicy is deprecated <span class="hljs-keyword">in</span> v1.21+, unavailable <span class="hljs-keyword">in</span> v1.25+<br>podsecuritypolicy.policy/controller created<br>podsecuritypolicy.policy/speaker created<br>serviceaccount/controller created<br>serviceaccount/speaker created<br>clusterrole.rbac.authorization.k8s.io/metallb-system:controller created<br>clusterrole.rbac.authorization.k8s.io/metallb-system:speaker created<br>role.rbac.authorization.k8s.io/config-watcher created<br>role.rbac.authorization.k8s.io/pod-lister created<br>role.rbac.authorization.k8s.io/controller created<br>clusterrolebinding.rbac.authorization.k8s.io/metallb-system:controller created<br>clusterrolebinding.rbac.authorization.k8s.io/metallb-system:speaker created<br>rolebinding.rbac.authorization.k8s.io/config-watcher created<br>rolebinding.rbac.authorization.k8s.io/pod-lister created<br>rolebinding.rbac.authorization.k8s.io/controller created<br>daemonset.apps/speaker created<br>deployment.apps/controller created<br><br><span class="hljs-comment"># 这里主要就是部署了controller这个deployment来检查service的状态</span><br>$ kubectl get deploy -n metallb-system<br>NAME         READY   UP-TO-DATE   AVAILABLE   AGE<br>controller   1/1     1            1           86s<br><span class="hljs-comment"># speaker则是使用ds部署到每个节点上面用来协商VIP、收发ARP、NDP等数据包</span><br>$ kubectl get ds -n metallb-system<br>NAME      DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR            AGE<br>speaker   3         3         3       3            3           kubernetes.io/os=linux   64s<br>$ kubectl get pod -n metallb-system -o wide<br>NAME                         READY   STATUS    RESTARTS   AGE    IP           NODE                                      NOMINATED NODE   READINESS GATES<br>controller-57fd9c5bb-svtjw   1/1     Running   0          117s   10.8.65.4    tiny-flannel-worker-8-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>speaker-bf79q                1/1     Running   0          117s   10.31.8.11   tiny-flannel-worker-8-11.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>speaker-fl5l8                1/1     Running   0          117s   10.31.8.12   tiny-flannel-worker-8-12.k8s.tcinternal   &lt;none&gt;           &lt;none&gt;<br>speaker-nw2fm                1/1     Running   0          117s   10.31.8.1    tiny-flannel-master-8-1.k8s.tcinternal    &lt;none&gt;           &lt;none&gt;<br><br>      <br>$ kubectl apply -f configmap-layer2.yaml<br>configmap/config created<br></code></pre></div></td></tr></table></figure>

<h2 id="3-4-部署测试服务"><a href="#3-4-部署测试服务" class="headerlink" title="3.4 部署测试服务"></a>3.4 部署测试服务</h2><p>我们还是自定义一个服务来进行测试，测试镜像使用nginx，默认情况下会返回请求客户端的IP和端口</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ <span class="hljs-built_in">cat</span> &gt; nginx-quic-lb.yaml &lt;&lt;<span class="hljs-string">EOF</span><br><span class="hljs-string">apiVersion: v1</span><br><span class="hljs-string">kind: Namespace</span><br><span class="hljs-string">metadata:</span><br><span class="hljs-string">  name: nginx-quic</span><br><span class="hljs-string"></span><br><span class="hljs-string">---</span><br><span class="hljs-string"></span><br><span class="hljs-string">apiVersion: apps/v1</span><br><span class="hljs-string">kind: Deployment</span><br><span class="hljs-string">metadata:</span><br><span class="hljs-string">  name: nginx-lb</span><br><span class="hljs-string">  namespace: nginx-quic</span><br><span class="hljs-string">spec:</span><br><span class="hljs-string">  selector:</span><br><span class="hljs-string">    matchLabels:</span><br><span class="hljs-string">      app: nginx-lb</span><br><span class="hljs-string">  replicas: 4</span><br><span class="hljs-string">  template:</span><br><span class="hljs-string">    metadata:</span><br><span class="hljs-string">      labels:</span><br><span class="hljs-string">        app: nginx-lb</span><br><span class="hljs-string">    spec:</span><br><span class="hljs-string">      containers:</span><br><span class="hljs-string">      - name: nginx-lb</span><br><span class="hljs-string">        image: tinychen777/nginx-quic:latest</span><br><span class="hljs-string">        imagePullPolicy: IfNotPresent</span><br><span class="hljs-string">        ports:</span><br><span class="hljs-string">        - containerPort: 80</span><br><span class="hljs-string"></span><br><span class="hljs-string">---</span><br><span class="hljs-string"></span><br><span class="hljs-string">apiVersion: v1</span><br><span class="hljs-string">kind: Service</span><br><span class="hljs-string">metadata:</span><br><span class="hljs-string">  name: nginx-lb-service</span><br><span class="hljs-string">  namespace: nginx-quic</span><br><span class="hljs-string">spec:</span><br><span class="hljs-string">  externalTrafficPolicy: Cluster</span><br><span class="hljs-string">  internalTrafficPolicy: Cluster</span><br><span class="hljs-string">  selector:</span><br><span class="hljs-string">    app: nginx-lb</span><br><span class="hljs-string">  ports:</span><br><span class="hljs-string">  - protocol: TCP</span><br><span class="hljs-string">    port: 80 # match for service access port</span><br><span class="hljs-string">    targetPort: 80 # match for pod access port</span><br><span class="hljs-string">  type: LoadBalancer</span><br><span class="hljs-string">  loadBalancerIP: 10.31.8.100</span><br><span class="hljs-string">EOF</span><br></code></pre></div></td></tr></table></figure>

<p>注意上面的配置中我们把service配置中的<code>type</code>字段指定为<code>LoadBalancer</code>，并且指定了<code>loadBalancerIP</code>为<code>10.31.8.100</code></p>
<blockquote>
<p>注意：并非所有的<code>LoadBalancer</code>都允许设置 <code>loadBalancerIP</code>。</p>
<p>如果<code>LoadBalancer</code>支持该字段，那么将根据用户设置的 <code>loadBalancerIP</code> 来创建负载均衡器。</p>
<p>如果没有设置 <code>loadBalancerIP</code> 字段，将会给负载均衡器指派一个临时 IP。 </p>
<p>如果设置了 <code>loadBalancerIP</code>，但<code>LoadBalancer</code>并不支持这种特性，那么设置的 <code>loadBalancerIP</code> 值将会被忽略掉。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 创建一个测试服务检查效果</span><br>$ kubectl apply -f nginx-quic-lb.yaml<br>namespace/nginx-quic created<br>deployment.apps/nginx-lb created<br>service/nginx-lb-service created<br></code></pre></div></td></tr></table></figure>

<p>查看服务状态，这时候TYPE已经变成<code>LoadBalancer</code>，<code>EXTERNAL-IP</code>显示为我们定义的<code>10.31.8.100</code></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 查看服务状态，这时候TYPE已经变成LoadBalancer</span><br>$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE<br>nginx-lb-service   LoadBalancer   10.8.32.221   10.31.8.100   80:30181/TCP   25h<br></code></pre></div></td></tr></table></figure>

<p>此时我们再去查看k8s机器中的<code>nginx-lb-service</code>状态，可以看到<code>ClusetIP</code>、<code>LoadBalancer-VIP</code>和<code>nodeport</code>的相关信息以及流量策略<code>TrafficPolicy</code>等配置</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic nginx-lb-service -o yaml<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    kubectl.kubernetes.io/last-applied-configuration: |<br>      &#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;Service&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;annotations&quot;</span>:&#123;&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;nginx-quic&quot;</span>&#125;,<span class="hljs-string">&quot;spec&quot;</span>:&#123;<span class="hljs-string">&quot;externalTrafficPolicy&quot;</span>:<span class="hljs-string">&quot;Cluster&quot;</span>,<span class="hljs-string">&quot;internalTrafficPolicy&quot;</span>:<span class="hljs-string">&quot;Cluster&quot;</span>,<span class="hljs-string">&quot;loadBalancerIP&quot;</span>:<span class="hljs-string">&quot;10.31.8.100&quot;</span>,<span class="hljs-string">&quot;ports&quot;</span>:[&#123;<span class="hljs-string">&quot;port&quot;</span>:80,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;TCP&quot;</span>,<span class="hljs-string">&quot;targetPort&quot;</span>:80&#125;],<span class="hljs-string">&quot;selector&quot;</span>:&#123;<span class="hljs-string">&quot;app&quot;</span>:<span class="hljs-string">&quot;nginx-lb&quot;</span>&#125;,<span class="hljs-string">&quot;type&quot;</span>:<span class="hljs-string">&quot;LoadBalancer&quot;</span>&#125;&#125;<br>  creationTimestamp: <span class="hljs-string">&quot;2022-05-16T06:01:23Z&quot;</span><br>  name: nginx-lb-service<br>  namespace: nginx-quic<br>  resourceVersion: <span class="hljs-string">&quot;1165135&quot;</span><br>  uid: f547842e-4547-4d01-abbc-89ac8b059a2a<br>spec:<br>  allocateLoadBalancerNodePorts: <span class="hljs-literal">true</span><br>  clusterIP: 10.8.32.221<br>  clusterIPs:<br>  - 10.8.32.221<br>  externalTrafficPolicy: Cluster<br>  internalTrafficPolicy: Cluster<br>  ipFamilies:<br>  - IPv4<br>  ipFamilyPolicy: SingleStack<br>  loadBalancerIP: 10.31.8.100<br>  ports:<br>  - nodePort: 30181<br>    port: 80<br>    protocol: TCP<br>    targetPort: 80<br>  selector:<br>    app: nginx-lb<br>  sessionAffinity: None<br>  <span class="hljs-built_in">type</span>: LoadBalancer<br>status:<br>  loadBalancer:<br>    ingress:<br>    - ip: 10.31.8.100<br></code></pre></div></td></tr></table></figure>

<p>查看IPVS规则，这时候可以看到ClusetIP、LoadBalancer-VIP和nodeport的转发规则，默认情况下在创建LoadBalance的时候还会创建nodeport服务：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ipvsadm -<span class="hljs-built_in">ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  172.17.0.1:30181 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br>TCP  10.8.32.221:80 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br>TCP  10.8.64.0:30181 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br>TCP  10.8.64.1:30181 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br>TCP  10.31.8.1:30181 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br>TCP  10.31.8.100:80 rr<br>  -&gt; 10.8.65.15:80                Masq    1      0          0<br>  -&gt; 10.8.65.16:80                Masq    1      0          0<br>  -&gt; 10.8.66.12:80                Masq    1      0          0<br>  -&gt; 10.8.66.13:80                Masq    1      0          0<br></code></pre></div></td></tr></table></figure>

<p>使用curl检查服务是否正常</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ curl 10.31.8.100:80<br>10.8.64.0:60854<br>$ curl 10.8.1.166:80<br>10.8.64.0:2562<br>$ curl 10.31.8.1:30974<br>10.8.64.0:1635<br>$ curl 10.31.8.100:80<br>10.8.64.0:60656<br></code></pre></div></td></tr></table></figure>

<h2 id="3-5-关于VIP"><a href="#3-5-关于VIP" class="headerlink" title="3.5 关于VIP"></a>3.5 关于VIP</h2><p>在每台k8s节点机器上面的<code>kube-ipvs0</code>网卡上面都能看到这个LoadBalancer的VIP：</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ip addr show kube-ipvs0<br>5: kube-ipvs0: &lt;BROADCAST,NOARP&gt; mtu 1500 qdisc noop state DOWN group default<br>    <span class="hljs-built_in">link</span>/ether 4e:ba:e8:25:cf:17 brd ff:ff:ff:ff:ff:ff<br>    inet 10.8.0.1/32 scope global kube-ipvs0<br>       valid_lft forever preferred_lft forever<br>    inet 10.8.0.10/32 scope global kube-ipvs0<br>       valid_lft forever preferred_lft forever<br>    inet 10.8.32.221/32 scope global kube-ipvs0<br>       valid_lft forever preferred_lft forever<br>    inet 10.31.8.100/32 scope global kube-ipvs0<br>       valid_lft forever preferred_lft forever<br></code></pre></div></td></tr></table></figure>

<p>想要定位到VIP在那个节点上面则比较麻烦，我们可以找一台和K8S集群处于同一个二层网络的机器，查看arp表，再根据mac地址找到对应的节点IP，这样子可以反查到IP在哪个节点上面。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ arp -a | grep 10.31.8.100<br>? (10.31.8.100) at 52:54:00:5c:9c:97 [ether] on eth0<br><br>$ arp -a | grep 52:54:00:5c:9c:97<br>tiny-flannel-worker-8-12.k8s.tcinternal (10.31.8.12) at 52:54:00:5c:9c:97 [ether] on eth0<br>? (10.31.8.100) at 52:54:00:5c:9c:97 [ether] on eth0<br><br>$ ip a | grep 52:54:00:5c:9c:97<br>    <span class="hljs-built_in">link</span>/ether 52:54:00:5c:9c:97 brd ff:ff:ff:ff:ff:ff<br></code></pre></div></td></tr></table></figure>

<p>又或者我们可以查看speaker的pod日志，我们可以找到对应的服务IP被宣告的日志记录</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl logs -f -n metallb-system speaker-fl5l8<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-16T06:11:34.099204376Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-16T06:12:09.527334808Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-16T06:12:09.547734268Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-16T06:12:34.267651651Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;layer2&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-16T06:12:34.286130424Z&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<h2 id="3-6-关于nodeport"><a href="#3-6-关于nodeport" class="headerlink" title="3.6 关于nodeport"></a>3.6 关于nodeport</h2><p>相信不少细心的同学已经发现了，我们在创建<code>LoadBalancer</code>服务的时候，默认情况下k8s会帮我们自动创建一个<code>nodeport</code>服务，这个操作可以通过指定<code>Service</code>中的<a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/services-networking/service/#load-balancer-nodeport-allocation"><code>allocateLoadBalancerNodePorts</code>字段</a>来定义开关，默认情况下为<code>true</code></p>
<p>不同的loadbalancer实现原理不同，有些是需要依赖nodeport来进行流量转发，有些则是直接转发请求到pod中。对于MetalLB而言，是通过kube-proxy将请求的流量直接转发到pod，因此我们需要关闭nodeport的话可以修改service中的<code>spec.allocateLoadBalancerNodePorts</code>字段，将其设置为false，那么在创建svc的时候就不会分配nodeport。</p>
<p>但是需要注意的是如果是对已有service进行修改，关闭nodeport（从true改为false），k8s不会自动去清除已有的ipvs规则，这需要我们自行手动删除。</p>
<p>我们重新定义创建一个svc</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-lb-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-quic</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">allocateLoadBalancerNodePorts:</span> <span class="hljs-literal">false</span><br>  <span class="hljs-attr">externalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">internalTrafficPolicy:</span> <span class="hljs-string">Cluster</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">nginx-lb</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for service access port</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># match for pod access port</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">loadBalancerIP:</span> <span class="hljs-number">10.31</span><span class="hljs-number">.8</span><span class="hljs-number">.100</span><br></code></pre></div></td></tr></table></figure>

<p>此时再去查看对应的svc状态和ipvs规则会发现已经没有nodeport相关的配置</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ ipvsadm -<span class="hljs-built_in">ln</span><br>IP Virtual Server version 1.2.1 (size=4096)<br>Prot LocalAddress:Port Scheduler Flags<br>  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn<br>TCP  10.8.62.180:80 rr<br>  -&gt; 10.8.65.18:80                Masq    1      0          0<br>  -&gt; 10.8.65.19:80                Masq    1      0          0<br>  -&gt; 10.8.66.14:80                Masq    1      0          0<br>  -&gt; 10.8.66.15:80                Masq    1      0          0<br>TCP  10.31.8.100:80 rr<br>  -&gt; 10.8.65.18:80                Masq    1      0          0<br>  -&gt; 10.8.65.19:80                Masq    1      0          0<br>  -&gt; 10.8.66.14:80                Masq    1      0          0<br>  -&gt; 10.8.66.15:80                Masq    1      0          0<br><br>$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)   AGE<br>nginx-lb-service   LoadBalancer   10.8.62.180   10.31.8.100   80/TCP    23s<br></code></pre></div></td></tr></table></figure>

<p>如果是把已有服务的<code>spec.allocateLoadBalancerNodePorts</code>从<code>true</code>改为<code>false</code>，原有的<code>nodeport</code>不会自动删除，因此最好在初始化的时候就规划好相关参数</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic nginx-lb-service -o yaml | egrep <span class="hljs-string">&quot; allocateLoadBalancerNodePorts: &quot;</span><br>  allocateLoadBalancerNodePorts: <span class="hljs-literal">false</span><br>$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP    EXTERNAL-IP   PORT(S)        AGE<br>nginx-lb-service   LoadBalancer   10.8.62.180   10.31.8.100   80:31405/TCP   85m<br></code></pre></div></td></tr></table></figure>

<h1 id="4、BGP-mode"><a href="#4、BGP-mode" class="headerlink" title="4、BGP mode"></a>4、BGP mode</h1><h2 id="4-1-网络拓扑"><a href="#4-1-网络拓扑" class="headerlink" title="4.1 网络拓扑"></a>4.1 网络拓扑</h2><p>测试环境的网络拓扑非常的简单，MetalLB的网段为了和前面Layer2模式进行区分，更换为<code>10.9.0.0/16</code>，具体信息如下</p>
<table>
<thead>
<tr>
<th align="center">IP</th>
<th align="center">Hostname</th>
</tr>
</thead>
<tbody><tr>
<td align="center">10.31.8.1</td>
<td align="center">tiny-flannel-master-8-1.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.8.11</td>
<td align="center">tiny-flannel-worker-8-11.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.8.12</td>
<td align="center">tiny-flannel-worker-8-12.k8s.tcinternal</td>
</tr>
<tr>
<td align="center">10.31.254.251</td>
<td align="center">OpenWrt</td>
</tr>
<tr>
<td align="center">10.9.0.0&#x2F;16</td>
<td align="center">MetalLB BGP IPpool</td>
</tr>
</tbody></table>
<p>三台k8s的节点直连Openwrt路由器，OpenWRT作为k8s节点的网关的同时，还在上面跑BGP协议，将对MetalLB使用的VIP的请求路由到各个k8s节点上。</p>
<p>在开始配置之前，我们需要给路由器和k8s节点都分配一个私有的AS号，这里可以参考<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Autonomous_system_(Internet)">wiki</a>上面的AS号划分使用。这里我们路由器使用AS号为64512，MetalLB使用AS号为64513。</p>
<h2 id="4-2-安装路由软件"><a href="#4-2-安装路由软件" class="headerlink" title="4.2 安装路由软件"></a>4.2 安装路由软件</h2><p>以家里常见的openwrt路由器为例，我们先在上面安装quagga组件，当然要是使用的openwrt版本<a target="_blank" rel="noopener" href="http://docs.frrouting.org/projects/dev-guide/en/latest/building-frr-for-openwrt.html">编译了frr模块</a>的话<strong>推荐使用frr</strong>来进行配置。</p>
<blockquote>
<p>如果使用的是别的发行版Linux（如CentOS或者Debian）推荐直接使用<a target="_blank" rel="noopener" href="https://frrouting.org/"><code>frr</code></a>进行配置。</p>
</blockquote>
<p>我们先在openwrt上面直接使用opkg安装quagga</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ opkg update <br>$ opkg install quagga quagga-zebra quagga-bgpd quagga-vtysh<br></code></pre></div></td></tr></table></figure>

<p>如果使用的openwrt版本足够新，是可以直接使用opkg安装frr组件的</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ opkg update <br>$ opkg install frr frr-babeld frr-bfdd frr-bgpd frr-eigrpd frr-fabricd frr-isisd frr-ldpd frr-libfrr frr-nhrpd frr-ospf6d frr-ospfd frr-pbrd frr-pimd frr-ripd frr-ripngd frr-staticd frr-vrrpd frr-vtysh frr-watchfrr frr-zebra<br></code></pre></div></td></tr></table></figure>

<p>如果是使用frr记得在配置中开启bgpd参数再重启frr</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ sed -i <span class="hljs-string">&#x27;s/bgpd=no/bgpd=yes/g&#x27;</span> /etc/frr/daemons<br>$ /etc/init.d/frr restart<br></code></pre></div></td></tr></table></figure>

<h2 id="4-3-配置路由器BGP"><a href="#4-3-配置路由器BGP" class="headerlink" title="4.3 配置路由器BGP"></a>4.3 配置路由器BGP</h2><p>下面的服务配置以<code>frr</code>为例，实际上使用<code>quagga</code>的话也是使用<code>vtysh</code>进行配置或者是直接修改配置文件，两者区别不大。</p>
<p>检查服务是否监听了2601和2605端口</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">root@OpenWrt:~<span class="hljs-comment"># netstat -ntlup | egrep &quot;zebra|bgpd&quot;</span><br>tcp        0      0 0.0.0.0:2601            0.0.0.0:*               LISTEN      3018/zebra<br>tcp        0      0 0.0.0.0:2605            0.0.0.0:*               LISTEN      3037/bgpd<br></code></pre></div></td></tr></table></figure>

<p>BGP协议使用的179端口还没有被监听是因为我们还没有进行配置，这里我们<strong>可以直接使用vtysh进行配置或者是直接修改配置文件然后重启服务</strong>。</p>
<p>直接在命令行输入vtysh就可以进入到vtysh的配置终端（和kvm虚拟化的virsh类似），这时候注意留意终端的提示符变化了</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">root@OpenWrt:~<span class="hljs-comment"># vtysh</span><br><br>Hello, this is Quagga (version 1.2.4).<br>Copyright 1996-2005 Kunihiro Ishiguro, et al.<br><br>OpenWrt<span class="hljs-comment">#</span><br></code></pre></div></td></tr></table></figure>

<p>但是命令行配置比较麻烦，我们也可以直接修改配置文件然后重启服务。</p>
<p>quagga修改的bgp配置文件默认是<code>/etc/quagga/bgpd.conf</code>，不同的发行版和安装方式可能会不同。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ <span class="hljs-built_in">cat</span> /etc/quagga/bgpd.conf<br>!<br>! Zebra configuration saved from vty<br>!   2022/05/19 11:01:35<br>!<br>password zebra<br>!<br>router bgp 64512<br> bgp router-id 10.31.254.251<br> neighbor 10.31.8.1 remote-as 64513<br> neighbor 10.31.8.1 description 10-31-8-1<br> neighbor 10.31.8.11 remote-as 64513<br> neighbor 10.31.8.11 description 10-31-8-11<br> neighbor 10.31.8.12 remote-as 64513<br> neighbor 10.31.8.12 description 10-31-8-12<br> maximum-paths 3<br>!<br> address-family ipv6<br> exit-address-family<br> <span class="hljs-built_in">exit</span><br>!<br>access-list vty permit 127.0.0.0/8<br>access-list vty deny any<br>!<br>line vty<br> access-class vty<br>!<br></code></pre></div></td></tr></table></figure>

<p>如果使用的是frr，那么配置文件会有所变化，需要修改的是<code>/etc/frr/frr.conf</code>，不同的发行版和安装方式可能会不同。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ <span class="hljs-built_in">cat</span> /etc/frr/frr.conf<br>frr version 8.2.2<br>frr defaults traditional<br>hostname tiny-openwrt-plus<br>!<br>password zebra<br>!<br>router bgp 64512<br> bgp router-id 10.31.254.251<br> no bgp ebgp-requires-policy<br> neighbor 10.31.8.1 remote-as 64513<br> neighbor 10.31.8.1 description 10-31-8-1<br> neighbor 10.31.8.11 remote-as 64513<br> neighbor 10.31.8.11 description 10-31-8-11<br> neighbor 10.31.8.12 remote-as 64513<br> neighbor 10.31.8.12 description 10-31-8-12<br> !<br> address-family ipv4 unicast<br> exit-address-family<br><span class="hljs-built_in">exit</span><br>!<br>access-list vty <span class="hljs-built_in">seq</span> 5 permit 127.0.0.0/8<br>access-list vty <span class="hljs-built_in">seq</span> 10 deny any<br>!<br>line vty<br> access-class vty<br><span class="hljs-built_in">exit</span><br>!<br></code></pre></div></td></tr></table></figure>

<p>完成配置后需要重启服务</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># 重启frr的命令</span><br>$ /etc/init.d/frr restart<br><span class="hljs-comment"># 重启quagge的命令</span><br>$ /etc/init.d/quagga restart<br></code></pre></div></td></tr></table></figure>

<p>重启后我们进入vtysh查看bgp的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tiny-openwrt-plus<span class="hljs-comment"># show ip bgp summary</span><br><br>IPv4 Unicast Summary (VRF default):<br>BGP router identifier 10.31.254.251, <span class="hljs-built_in">local</span> AS number 64512 vrf-id 0<br>BGP table version 0<br>RIB entries 0, using 0 bytes of memory<br>Peers 3, using 2149 KiB of memory<br><br>Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc<br>10.31.8.1       4      64513         0         0        0    0    0    never       Active        0 10-31-8-1<br>10.31.8.11      4      64513         0         0        0    0    0    never       Active        0 10-31-8-11<br>10.31.8.12      4      64513         0         0        0    0    0    never       Active        0 10-31-8-12<br><br>Total number of neighbors 3<br></code></pre></div></td></tr></table></figure>

<p>这时候再查看路由器的监听端口，可以看到BGP已经跑起来了</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ netstat -ntlup | egrep <span class="hljs-string">&quot;zebra|bgpd&quot;</span><br>tcp        0      0 127.0.0.1:2605          0.0.0.0:*               LISTEN      31625/bgpd<br>tcp        0      0 127.0.0.1:2601          0.0.0.0:*               LISTEN      31618/zebra<br>tcp        0      0 0.0.0.0:179             0.0.0.0:*               LISTEN      31625/bgpd<br>tcp        0      0 :::179                  :::*                    LISTEN      31625/bgpd<br></code></pre></div></td></tr></table></figure>



<h2 id="4-4-配置MetalLB-BGP"><a href="#4-4-配置MetalLB-BGP" class="headerlink" title="4.4 配置MetalLB BGP"></a>4.4 配置MetalLB BGP</h2><p>首先我们修改configmap</p>
<figure class="highlight yaml"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ConfigMap</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">metallb-system</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">config</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">config:</span> <span class="hljs-string">|</span><br><span class="hljs-string">    peers:</span><br><span class="hljs-string">    - peer-address: 10.31.254.251</span><br><span class="hljs-string">      peer-port: 179</span><br><span class="hljs-string">      peer-asn: 64512</span><br><span class="hljs-string">      my-asn: 64513</span><br><span class="hljs-string">    address-pools:</span><br><span class="hljs-string">    - name: default</span><br><span class="hljs-string">      protocol: bgp</span><br><span class="hljs-string">      addresses:</span><br><span class="hljs-string">      - 10.9.0.0/16</span><br></code></pre></div></td></tr></table></figure>

<p>修改完成后我们重新部署<code>configmap</code>，并检查<code>metallb</code>的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl apply -f configmap-metal.yaml<br>configmap/config configured<br><br>$ kubectl get cm -n metallb-system config -o yaml<br>apiVersion: v1<br>data:<br>  config: |<br>    peers:<br>    - peer-address: 10.31.254.251<br>      peer-port: 179<br>      peer-asn: 64512<br>      my-asn: 64513<br>    address-pools:<br>    - name: default<br>      protocol: bgp<br>      addresses:<br>      - 10.9.0.0/16<br>kind: ConfigMap<br>metadata:<br>  annotations:<br>    kubectl.kubernetes.io/last-applied-configuration: |<br>      &#123;<span class="hljs-string">&quot;apiVersion&quot;</span>:<span class="hljs-string">&quot;v1&quot;</span>,<span class="hljs-string">&quot;data&quot;</span>:&#123;<span class="hljs-string">&quot;config&quot;</span>:<span class="hljs-string">&quot;peers:\n- peer-address: 10.31.254.251\n  peer-port: 179\n  peer-asn: 64512\n  my-asn: 64513\naddress-pools:\n- name: default\n  protocol: bgp\n  addresses:\n  - 10.9.0.0/16\n&quot;</span>&#125;,<span class="hljs-string">&quot;kind&quot;</span>:<span class="hljs-string">&quot;ConfigMap&quot;</span>,<span class="hljs-string">&quot;metadata&quot;</span>:&#123;<span class="hljs-string">&quot;annotations&quot;</span>:&#123;&#125;,<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;config&quot;</span>,<span class="hljs-string">&quot;namespace&quot;</span>:<span class="hljs-string">&quot;metallb-system&quot;</span>&#125;&#125;<br>  creationTimestamp: <span class="hljs-string">&quot;2022-05-16T04:37:54Z&quot;</span><br>  name: config<br>  namespace: metallb-system<br>  resourceVersion: <span class="hljs-string">&quot;1412854&quot;</span><br>  uid: 6d94ca36-93fe-4ea2-9407-96882ad8e35c<br></code></pre></div></td></tr></table></figure>

<p>此时我们从路由器上面可以看到已经和三个k8s节点建立了BGP连接</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tiny-openwrt-plus<span class="hljs-comment"># show ip bgp summary</span><br><br>IPv4 Unicast Summary (VRF default):<br>BGP router identifier 10.31.254.251, <span class="hljs-built_in">local</span> AS number 64512 vrf-id 0<br>BGP table version 3<br>RIB entries 5, using 920 bytes of memory<br>Peers 3, using 2149 KiB of memory<br><br>Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc<br>10.31.8.1       4      64513         6         4        0    0    0 00:00:45            3        3 10-31-8-1<br>10.31.8.11      4      64513         6         4        0    0    0 00:00:45            3        3 10-31-8-11<br>10.31.8.12      4      64513         6         4        0    0    0 00:00:45            3        3 10-31-8-12<br><br>Total number of neighbors 3<br></code></pre></div></td></tr></table></figure>

<p>如果出现某个节点的BGP连接建立失败的情况，可以重启该节点上面的speaker来重试建立BGP连接</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl delete po speaker-fl5l8 -n metallb-system<br></code></pre></div></td></tr></table></figure>



<h2 id="4-5-配置Service"><a href="#4-5-配置Service" class="headerlink" title="4.5 配置Service"></a>4.5 配置Service</h2><p>当configmap更改生效之后，原有服务的<code>EXTERNAL-IP</code>不会重新分配</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>nginx-lb-service   LoadBalancer   10.8.4.92    10.31.8.100   80/TCP    18h<br></code></pre></div></td></tr></table></figure>

<p>此时我们可以重启<code>controller</code>，让它重新为我们的服务分配<code>EXTERNAL-IP</code></p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl delete po -n metallb-system controller-57fd9c5bb-svtjw<br>pod <span class="hljs-string">&quot;controller-57fd9c5bb-svtjw&quot;</span> deleted<br></code></pre></div></td></tr></table></figure>

<p>重启完成之后我们再检查svc的状态，如果svc的配置中关于LoadBalancer的VIP是自动分配的（即没有指定<code>loadBalancerIP</code>字段），那么这时候应该就已经拿到新的IP在正常运行了，但是我们这个服务的<code>loadBalancerIP</code>之前手动指定为10.31.8.100了，这里的<code>EXTERNAL-IP</code>状态就变为<code>pending</code>。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>nginx-lb-service   LoadBalancer   10.8.4.92    &lt;pending&gt;     80/TCP    18h<br></code></pre></div></td></tr></table></figure>

<p>重新修改<code>loadBalancerIP</code>为<code>10.9.1.1</code>，此时可以看到服务已经正常</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl get svc -n nginx-quic<br>NAME               TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>nginx-lb-service   LoadBalancer   10.8.4.92    10.9.1.1      80/TCP    18h<br></code></pre></div></td></tr></table></figure>

<p>再查看controller的日志可以看到</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl logs controller-57fd9c5bb-d6jsl -n metallb-system<br>&#123;<span class="hljs-string">&quot;branch&quot;</span>:<span class="hljs-string">&quot;HEAD&quot;</span>,<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;commit&quot;</span>:<span class="hljs-string">&quot;v0.12.1&quot;</span>,<span class="hljs-string">&quot;goversion&quot;</span>:<span class="hljs-string">&quot;gc / go1.16.14 / amd64&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;MetalLB controller starting version 0.12.1 (commit v0.12.1, branch HEAD)&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.440872105Z&quot;</span>,<span class="hljs-string">&quot;version&quot;</span>:<span class="hljs-string">&quot;0.12.1&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;configmap&quot;</span>:<span class="hljs-string">&quot;metallb-system/config&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;configLoaded&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;config (re)loaded&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.610395481Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;[\&quot;10.31.8.100\&quot;] is not allowed in config&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;clearAssignment&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;current IP not allowed by config, clearing&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.611009691Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;clearAssignment&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;user requested a different IP than the one currently assigned&quot;</span>,<span class="hljs-string">&quot;reason&quot;</span>:<span class="hljs-string">&quot;differentIPRequested&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.611062419Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;controller not synced&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;controller not synced yet, cannot allocate IP; will retry after sync&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;allocateIPs&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.611080525Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;stateSynced&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;controller synced, can allocate IPs now&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.611117023Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;[\&quot;10.31.8.100\&quot;] is not allowed in config&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;clearAssignment&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;current IP not allowed by config, clearing&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.617013146Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;clearAssignment&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;user requested a different IP than the one currently assigned&quot;</span>,<span class="hljs-string">&quot;reason&quot;</span>:<span class="hljs-string">&quot;differentIPRequested&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.617089367Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;[\&quot;10.31.8.100\&quot;] is not allowed in config&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP allocation failed&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;allocateIPs&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.617122976Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceUpdated&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;updated service object&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.626039403Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;[\&quot;10.31.8.100\&quot;] is not allowed in config&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP allocation failed&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;allocateIPs&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:45:45.626361986Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;ipAllocated&quot;</span>,<span class="hljs-string">&quot;ip&quot;</span>:[<span class="hljs-string">&quot;10.9.1.1&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP address assigned by controller&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:47:19.943434144Z&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>再查看speaker的日志我们可以看到和路由之间成功建立BGP连接的日志、使用了不符合规范的<code>loadBalancerIP</code>10.31.8.100的报错日志，以及为<code>loadBalancerIP</code>10.9.1.1分配BGP路由的日志</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ kubectl logs -n metallb-system speaker-bf79q<br><br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;configmap&quot;</span>:<span class="hljs-string">&quot;metallb-system/config&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;peerAdded&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;peer configured, starting BGP session&quot;</span>,<span class="hljs-string">&quot;peer&quot;</span>:<span class="hljs-string">&quot;10.31.254.251&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:41:55.046091105Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;configmap&quot;</span>:<span class="hljs-string">&quot;metallb-system/config&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;configLoaded&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;config (re)loaded&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:41:55.046268735Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;assigned IP not allowed by config&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP allocated by controller not allowed by config&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;setBalancer&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:41:55.051955069Z&quot;</span>&#125;<br>struct &#123; Version uint8; ASN16 uint16; HoldTime uint16; RouterID uint32; OptsLen uint8 &#125;&#123;Version:0x4, ASN16:0xfc00, HoldTime:0xb4, RouterID:0xa1ffefd, OptsLen:0x1e&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;sessionUp&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;localASN&quot;</span>:64513,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;BGP session established&quot;</span>,<span class="hljs-string">&quot;peer&quot;</span>:<span class="hljs-string">&quot;10.31.254.251:179&quot;</span>,<span class="hljs-string">&quot;peerASN&quot;</span>:64512,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:41:55.052734174Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;triggering discovery&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;memberDiscovery&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:42:40.183574415Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;node event - forcing sync&quot;</span>,<span class="hljs-string">&quot;node addr&quot;</span>:<span class="hljs-string">&quot;10.31.8.12&quot;</span>,<span class="hljs-string">&quot;node event&quot;</span>:<span class="hljs-string">&quot;NodeLeave&quot;</span>,<span class="hljs-string">&quot;node name&quot;</span>:<span class="hljs-string">&quot;tiny-flannel-worker-8-12.k8s.tcinternal&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:44:03.649494062Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;assigned IP not allowed by config&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP allocated by controller not allowed by config&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;setBalancer&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:44:03.655003303Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;node event - forcing sync&quot;</span>,<span class="hljs-string">&quot;node addr&quot;</span>:<span class="hljs-string">&quot;10.31.8.12&quot;</span>,<span class="hljs-string">&quot;node event&quot;</span>:<span class="hljs-string">&quot;NodeJoin&quot;</span>,<span class="hljs-string">&quot;node name&quot;</span>:<span class="hljs-string">&quot;tiny-flannel-worker-8-12.k8s.tcinternal&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:44:06.247929645Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;error&quot;</span>:<span class="hljs-string">&quot;assigned IP not allowed by config&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.31.8.100&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;error&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;IP allocated by controller not allowed by config&quot;</span>,<span class="hljs-string">&quot;op&quot;</span>:<span class="hljs-string">&quot;setBalancer&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:44:06.25369106Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;updatedAdvertisements&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.9.1.1&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;making advertisements using BGP&quot;</span>,<span class="hljs-string">&quot;numAds&quot;</span>:1,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;bgp&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:47:19.953729779Z&quot;</span>&#125;<br>&#123;<span class="hljs-string">&quot;caller&quot;</span>:<span class="hljs-string">&quot;level.go:63&quot;</span>,<span class="hljs-string">&quot;event&quot;</span>:<span class="hljs-string">&quot;serviceAnnounced&quot;</span>,<span class="hljs-string">&quot;ips&quot;</span>:[<span class="hljs-string">&quot;10.9.1.1&quot;</span>],<span class="hljs-string">&quot;level&quot;</span>:<span class="hljs-string">&quot;info&quot;</span>,<span class="hljs-string">&quot;msg&quot;</span>:<span class="hljs-string">&quot;service has IP, announcing&quot;</span>,<span class="hljs-string">&quot;pool&quot;</span>:<span class="hljs-string">&quot;default&quot;</span>,<span class="hljs-string">&quot;protocol&quot;</span>:<span class="hljs-string">&quot;bgp&quot;</span>,<span class="hljs-string">&quot;service&quot;</span>:<span class="hljs-string">&quot;nginx-quic/nginx-lb-service&quot;</span>,<span class="hljs-string">&quot;ts&quot;</span>:<span class="hljs-string">&quot;2022-05-18T03:47:19.953912236Z&quot;</span>&#125;<br></code></pre></div></td></tr></table></figure>

<p>我们在集群外的任意一个机器进行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">$ curl -v 10.9.1.1<br>* About to connect() to 10.9.1.1 port 80 (<span class="hljs-comment">#0)</span><br>*   Trying 10.9.1.1...<br>* Connected to 10.9.1.1 (10.9.1.1) port 80 (<span class="hljs-comment">#0)</span><br>&gt; GET / HTTP/1.1<br>&gt; User-Agent: curl/7.29.0<br>&gt; Host: 10.9.1.1<br>&gt; Accept: */*<br>&gt;<br>&lt; HTTP/1.1 200 OK<br>&lt; Server: nginx<br>&lt; Date: Wed, 18 May 2022 04:17:41 GMT<br>&lt; Content-Type: text/plain<br>&lt; Content-Length: 16<br>&lt; Connection: keep-alive<br>&lt;<br>10.8.64.0:43939<br>* Connection <span class="hljs-comment">#0 to host 10.9.1.1 left intact</span><br></code></pre></div></td></tr></table></figure>

<h2 id="4-6-检查ECMP"><a href="#4-6-检查ECMP" class="headerlink" title="4.6 检查ECMP"></a>4.6 检查ECMP</h2><p>此时再查看路由器上面的路由状态，可以看到有关于<code>10.9.1.1</code>的<code>/32</code>路由，这时候的下一条有多个IP，说明已经成功开启了ECMP。</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tiny-openwrt-plus<span class="hljs-comment"># show ip route</span><br>Codes: K - kernel route, C - connected, S - static, R - RIP,<br>       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,<br>       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,<br>       f - OpenFabric,<br>       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup<br>       t - trapped, o - offload failure<br><br>K&gt;* 0.0.0.0/0 [0/0] via 10.31.254.254, eth0, 00:04:52<br>B&gt;* 10.9.1.1/32 [20/0] via 10.31.8.1, eth0, weight 1, 00:01:40<br>  *                    via 10.31.8.11, eth0, weight 1, 00:01:40<br>  *                    via 10.31.8.12, eth0, weight 1, 00:01:40<br>C&gt;* 10.31.0.0/16 is directly connected, eth0, 00:04:52<br></code></pre></div></td></tr></table></figure>

<p>我们再创建多几个服务进行测试</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash"><span class="hljs-comment"># kubectl get svc -n nginx-quic</span><br>NAME                TYPE           CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE<br>nginx-lb-service    LoadBalancer   10.8.4.92    10.9.1.1      80/TCP    23h<br>nginx-lb2-service   LoadBalancer   10.8.10.48   10.9.1.2      80/TCP    64m<br>nginx-lb3-service   LoadBalancer   10.8.6.116   10.9.1.3      80/TCP    64m<br></code></pre></div></td></tr></table></figure>

<p>再查看此时路由器的状态</p>
<figure class="highlight bash"><table><tr><td class="gutter hljs"><div class="hljs code-wrapper"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></div></td><td class="code"><div class="hljs code-wrapper"><pre><code class="hljs bash">tiny-openwrt-plus<span class="hljs-comment"># show ip bgp</span><br>BGP table version is 3, <span class="hljs-built_in">local</span> router ID is 10.31.254.251, vrf <span class="hljs-built_in">id</span> 0<br>Default <span class="hljs-built_in">local</span> pref 100, <span class="hljs-built_in">local</span> AS 64512<br>Status codes:  s suppressed, d damped, h <span class="hljs-built_in">history</span>, * valid, &gt; best, = multipath,<br>               i internal, r RIB-failure, S Stale, R Removed<br>Nexthop codes: @NNN nexthop<span class="hljs-string">&#x27;s vrf id, &lt; announce-nh-self</span><br><span class="hljs-string">Origin codes:  i - IGP, e - EGP, ? - incomplete</span><br><span class="hljs-string">RPKI validation codes: V valid, I invalid, N Not found</span><br><span class="hljs-string"></span><br><span class="hljs-string">   Network          Next Hop            Metric LocPrf Weight Path</span><br><span class="hljs-string">*= 10.9.1.1/32      10.31.8.12                             0 64513 ?</span><br><span class="hljs-string">*&gt;                  10.31.8.1                              0 64513 ?</span><br><span class="hljs-string">*=                  10.31.8.11                             0 64513 ?</span><br><span class="hljs-string">*= 10.9.1.2/32      10.31.8.12                             0 64513 ?</span><br><span class="hljs-string">*&gt;                  10.31.8.1                              0 64513 ?</span><br><span class="hljs-string">*=                  10.31.8.11                             0 64513 ?</span><br><span class="hljs-string">*= 10.9.1.3/32      10.31.8.12                             0 64513 ?</span><br><span class="hljs-string">*&gt;                  10.31.8.1                              0 64513 ?</span><br><span class="hljs-string">*=                  10.31.8.11                             0 64513 ?</span><br><span class="hljs-string"></span><br><span class="hljs-string">Displayed  3 routes and 9 total paths</span><br><span class="hljs-string"></span><br><span class="hljs-string"></span><br><span class="hljs-string">tiny-openwrt-plus# show ip route</span><br><span class="hljs-string">Codes: K - kernel route, C - connected, S - static, R - RIP,</span><br><span class="hljs-string">       O - OSPF, I - IS-IS, B - BGP, E - EIGRP, N - NHRP,</span><br><span class="hljs-string">       T - Table, v - VNC, V - VNC-Direct, A - Babel, F - PBR,</span><br><span class="hljs-string">       f - OpenFabric,</span><br><span class="hljs-string">       &gt; - selected route, * - FIB route, q - queued, r - rejected, b - backup</span><br><span class="hljs-string">       t - trapped, o - offload failure</span><br><span class="hljs-string"></span><br><span class="hljs-string">K&gt;* 0.0.0.0/0 [0/0] via 10.31.254.254, eth0, 00:06:12</span><br><span class="hljs-string">B&gt;* 10.9.1.1/32 [20/0] via 10.31.8.1, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.11, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.12, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">B&gt;* 10.9.1.2/32 [20/0] via 10.31.8.1, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.11, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.12, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">B&gt;* 10.9.1.3/32 [20/0] via 10.31.8.1, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.11, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">  *                    via 10.31.8.12, eth0, weight 1, 00:03:00</span><br><span class="hljs-string">C&gt;* 10.31.0.0/16 is directly connected, eth0, 00:06:12</span><br></code></pre></div></td></tr></table></figure>

<p>只有当路由表显示我们的LoadBalancerIP的下一跳有多个IP的时候，才说明ECMP配置成功，否则需要检查BGP的配置是否正确。</p>
<h1 id="5、总结"><a href="#5、总结" class="headerlink" title="5、总结"></a>5、总结</h1><h2 id="5-1-Layer2-mode优缺点"><a href="#5-1-Layer2-mode优缺点" class="headerlink" title="5.1 Layer2 mode优缺点"></a>5.1 Layer2 mode优缺点</h2><p><strong>优点：</strong></p>
<ul>
<li>通用性强，对比BGP模式不需要BGP路由器支持，几乎可以适用于任何网络环境；当然云厂商的网络环境例外</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>所有的流量都会在同一个节点上，该节点的容易成为流量的瓶颈</li>
<li>当VIP所在节点宕机之后，需要较长时间进行故障转移（一般在10s），这主要是因为MetalLB使用了<a target="_blank" rel="noopener" href="https://github.com/hashicorp/memberlist">memberlist</a>来进行选主，当VIP所在节点宕机之后重新选主的时间要比传统的keepalived使用的vrrp协议要更长</li>
<li>难以定位VIP所在节点，MetalLB并没有提供一个简单直观的方式让我们查看到底哪一个节点是VIP所属节点，基本只能通过抓包或者查看pod日志来确定，当集群规模变大的时候这会变得非常的麻烦</li>
</ul>
<p><strong>改进方案：</strong></p>
<ul>
<li>有条件的可以考虑使用BGP模式</li>
<li>既不能用BGP模式也不能接受Layer2模式的，基本和目前主流的三个开源负载均衡器无缘了（三者都是Layer2模式和BGP模式且原理类似，优缺点相同）</li>
</ul>
<h2 id="5-2-BGP-mode优缺点"><a href="#5-2-BGP-mode优缺点" class="headerlink" title="5.2 BGP mode优缺点"></a>5.2 BGP mode优缺点</h2><p>BGP模式的优缺点几乎和Layer2模式相反</p>
<p><strong>优点：</strong></p>
<ul>
<li>无单点故障，在开启ECMP的前提下，k8s集群内所有的节点都有请求流量，都会参与负载均衡并转发请求</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>条件苛刻，需要有BGP路由器支持，配置起来也更复杂；</li>
<li>ECMP的故障转移（failover）并不是特别地优雅，这个问题的严重程度取决于使用的ECMP算法；当集群的节点出现变动导致BGP连接出现变动，所有的连接都会进行重新哈希（使用三元组或五元组哈希），这对一些服务来说可能会有影响；</li>
</ul>
<blockquote>
<p>路由器中使用的哈希值通常 <em>不稳定</em>，因此每当后端集的大小发生变化时（例如，当一个节点的 BGP 会话关闭时），现有的连接将被有效地随机重新哈希，这意味着大多数现有的连接最终会突然被转发到不同的后端，而这个后端可能和此前的后端毫不相干且不清楚上下文状态信息。</p>
</blockquote>
<p><strong>改进方案：</strong></p>
<p>MetalLB给出了一些<a target="_blank" rel="noopener" href="https://metallb.universe.tf/concepts/bgp/#limitations">改进方案</a>，下面列出来给大家参考一下</p>
<ul>
<li>使用更稳定的ECMP算法来减少后端变动时对现有连接的影响，如“resilient ECMP” or “resilient LAG”</li>
<li>将服务部署到特定的节点上减少可能带来的影响</li>
<li>在流量低峰期进行变更</li>
<li>将服务分开部署到两个不同的LoadBalanceIP的服务中，然后利用DNS进行流量切换</li>
<li>在客户端加入透明的用户无感的重试逻辑</li>
<li>在LoadBalance后面加入一层ingress来实现更优雅的failover（但是并不是所有的服务都可以使用ingress）</li>
<li>接受现实……（Accept that there will be occasional bursts of reset connections. For low-availability internal services, this may be acceptable as-is.）</li>
</ul>
<h2 id="5-3-MetalLB的优缺点"><a href="#5-3-MetalLB的优缺点" class="headerlink" title="5.3 MetalLB的优缺点"></a>5.3 MetalLB的优缺点</h2><p>这里尽量客观的总结概况一些客观事实，是否为优缺点可能会因人而异：</p>
<ul>
<li>开源时间久（相对于云原生负载均衡器而言），有一定的社区基础和热度，但是项目目前还处于beta状态</li>
<li>部署简单快捷，默认情况下需要配置的参数不多，可以快速上手</li>
<li>官方文档不多，只有一些基础的配置和说明，想要深入了解，可能需要阅读源码</li>
<li>进阶管理配置不便，如果你想精确了解服务的当前状态，可能会比较麻烦</li>
<li>configmap修改之后生效不是特别的优雅，很多情况下需要我们手动重启pod</li>
</ul>
<p>总的来说，MetalLB作为一款处于beta阶段的开源负载均衡器，很好地弥补了这一块领域的空白，并且对后面开源的一些同类服务有着一定的影响。但是从实际生产落地的角度，<strong>给我的感觉就是目前更倾向于有得用且能用，并不能算得上好用</strong>，但是又考虑到MetalLB最开始只是一个个人开源项目，最近才有专门的组织进行管理维护，这也是可以理解的，希望它能够发展得更好吧。</p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                  <div class="post-meta mr-3">
                    <i class="iconfont icon-category"></i>
                    
                      <a class="hover-with-bg" href="/categories/cloudnative/">cloudnative</a>
                    
                  </div>
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/k8s/">k8s</a>
                    
                      <a class="hover-with-bg" href="/tags/loadbalance/">loadbalance</a>
                    
                      <a class="hover-with-bg" href="/tags/metallb/">metallb</a>
                    
                      <a class="hover-with-bg" href="/tags/openelb/">openelb</a>
                    
                      <a class="hover-with-bg" href="/tags/purelb/">purelb</a>
                    
                      <a class="hover-with-bg" href="/tags/bgp/">bgp</a>
                    
                      <a class="hover-with-bg" href="/tags/quagga/">quagga</a>
                    
                      <a class="hover-with-bg" href="/tags/frr/">frr</a>
                    
                  </div>
                
              </div>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/20220523-k8s-07-loadbalancer-openelb/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">k8s系列07-负载均衡器之OpenELB</span>
                        <span class="visible-mobile">Previous</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/20220512-k8s-05-deploy-k8s-without-kubeproxy/">
                        <span class="hidden-mobile">k8s系列05-使用containerd和cilium部署kubeproxy-free的k8s集群</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;TOC</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <i class="iconfont icon-copyright"></i> <a href="https://tinychen.com/" target="_blank" rel="nofollow noopener"><span>since 2017 By TinyChen </span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Hexo-Fluid</span></a> 
  </div>
  

  
  <!-- 备案信息 -->
  <div class="beian">
    <span>
      <a href="http://beian.miit.gov.cn/" target="_blank" rel="nofollow noopener">
        粤ICP备18140640号
      </a>
    </span>
    
  </div>


  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js" ></script>
  






  <script  src="https://cdn.jsdelivr.net/npm/typed.js@2/lib/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var title = document.getElementById('subtitle').title;
      
        typing(title);
      
    })(window, document);
  </script>












  
    <!-- Baidu Analytics -->
    <script defer>
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?7a96963a1145ac7fde1442d739a11ffd";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  
    <!-- Google Analytics -->
    <script defer>
      window.ga = window.ga || function () { (ga.q = ga.q || []).push(arguments) };
      ga.l = +new Date;
      ga('create', 'UA-166769908-1', 'auto');
      ga('send', 'pageview');
    </script>
    <script async src='https://www.google-analytics.com/analytics.js'></script>
  

  

  

  

  





<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
